;/*FB_PKG_DELIM*/

__d("EchoCommonUtils",[],(function(a,b,c,d,e,f){"use strict";c="Echo-Doc-Version";function a(a,b){var c=a.localKey;a=a.transportKey;return c+"@"+a+"-"+b}function b(a,b,c){return a==null?{localKey:b,transportKey:c}:{displayName:a,localKey:b,transportKey:c}}f.ECHO_COMMON_FIELD_DOCUMENT_VERSION=c;f.getEchoAddressFieldNameWithSuffix=a;f.craftEchoAddress=b}),66);
__d("EchoConstants",[],(function(a,b,c,d,e,f){"use strict";a=new Set(["\0","\x01","\x02","\x03","\x04","\x05","\x06","\x07","\b","\t","\n","\v","\f","\r","\x0e","\x0f","\x10","\x11","\x12","\x13","\x14","\x15","\x16","\x17","\x18","\x19","\x1a","\x1b","\x1c","\x1d","\x1e","\x1f",'"'," ","(",")",",",":",";","<",">","@","[","]","\\"]);f.ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE=a}),66);
__d("EchoDecodingUtils",["invariant","EchoConstants","WALogger"],(function(a,b,c,d,e,f,g,h){"use strict";var i,j,k,l,m,n,o,p,q,r,s,t,u,v=new Set([]);function w(a,b){if(a.length===0)return;var c=a.indexOf(":");if(c===-1){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] This is a raw line and we cannot decode its field name and value."])));return}var e=a.substring(0,c).trim();a=a.substring(c+1).trim();if(e.length===0){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Field name is blank"])));return}if(a.length===0){b.has(e)&&b["delete"](e);return}b.set(e,a)}function x(a,b,c,e){c===void 0&&(c=new Set());var f=!1,g=b==="conditional"&&a[0]==='"',h="",i=g?1:0;while(i<a.length){var j=a[i];if(b==="conditional"&&!g&&j==='"')break;if(!g&&c.has(j))break;if(g&&!f&&j==='"'){g=!1;i++;break}if(g&&!f&&j==="\\"){if(i===a.length-1)break;f=!0}else f&&j==="r"?h+="\r":f&&j==="n"?h+="\n":h+=j,f=!1;i++}if(g||h.length===0){j=e!=null?e:"unknown";d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail decoding because we didn't have a closing quote. Error Field: ",""])),j);return{remainder:a,result:null,success:!1}}return{remainder:a.substring(i),result:h,success:!0}}function y(a,b){if(a.length===0){d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddress"])));return{remainder:a,result:null,success:!1}}var c=a.trimLeft();c=x(c,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,b);if(!c.success){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] conditional quote mode decode failed"])));return{remainder:a,result:null,success:!1}}c.result!=null||h(0,47923);if(c.remainder[0]==="@"){var e=z(c.remainder,c.result,b);return{remainder:e.remainder,result:e.result,success:e.success}}e=c.result;c=c.remainder.trimLeft();if(c.startsWith("<")){c=z(c.substring(1),void 0,b);b=c.result;var f=c.remainder;if(c.success&&b!=null&&f.startsWith(">"))if(e.length===0)return{remainder:f.substring(1),result:b,success:!0};else return{remainder:f.substring(1),result:babelHelpers["extends"]({},b,{displayName:e}),success:!0}}d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echoDecodeAddress failed"])));return{remainder:a,result:null,success:!1}}function z(a,b,c){var e=b==null?a.trimLeft():a;b=b;if(b==null){var f=x(e,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,c);if(!f.success){d("WALogger").ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] parse localKey in address failed"])));return{remainder:a,result:null,success:!1}}b=f.result;e=f.remainder}if(b==null||b.length===0||e[0]!=="@"){d("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid localKey in address detected"])));return{remainder:a,result:null,success:!1}}f=x(e.substring(1),"never",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,c);e=f.result;if(f.success&&e!=null&&e.length>0)return{remainder:f.remainder,result:{localKey:b,transportKey:e},success:!0};else{d("WALogger").ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid transportKey in address detected"])));return{remainder:a,result:null,success:!1}}}function A(a,b){if(a.length===0){d("WALogger").ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddressList detected"])));return{result:null,success:!1}}var c=y(a,b);if(!c.success){d("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Address  decode failed with value: ",""])),a);return{result:null,success:!1}}c.result!=null||h(0,47927);a=[c.result];c=c.remainder;while(c.startsWith(",")){var e=y(c.substring(1).trimLeft(),b);if(e.success)e.result!=null&&a.push(e.result),c=e.remainder;else break}return{result:a,success:!0}}function a(a){var b=new Map(),c=a.split("\r\n");if(c.length===1&&c[0]===a){d("WALogger").ERROR(t||(t=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail to decode if the input string does not have CRLF"])));return b}c.forEach(function(a){return w(a,b)});return b}function b(a,b){a=a.get(b);if(a==null||a.length===0||a==='""')return{result:null,success:!1};a=x(a,"conditional",v,b);b=a.result;a=a.success;return{result:b,success:a}}function c(a,b){a=B(a,b);return{result:(b=a.result)!=null?b:0,success:a.success}}function B(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};a=parseInt(a,10);if(isNaN(a)){d("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] "," not a valid number in echo message"])),b);return{result:null,success:!1}}else return Number.isSafeInteger(a)?{result:a,success:!0}:{result:a>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,success:!0}}function e(a,b){a=C(a,b);return{result:(b=a.result)!=null?b:!1,success:a.success}}function C(a,b){a=B(a,b);return!a.success||a.result!==0&&a.result!==1?{result:null,success:!1}:{result:a.result===1,success:!0}}function f(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};a=y(a,b);b=a.result;a=a.success;return{result:b,success:a}}function D(a,b){a=a.get(b);return a==null||a.length===0?{result:null,success:!1}:A(a,b)}function E(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};b=a.split(",").map(function(a){return a.trim()}).filter(Boolean);return b.length===0?{result:null,success:!1}:{result:b,success:!0}}g.echoDecodeFields=a;g.echoDecodeStringField=b;g.echoDecodeIntField=c;g.echoDecodeNullableIntField=B;g.echoDecodeBooleanField=e;g.echoDecodeNullableBooleanField=C;g.echoDecodeAddressField=f;g.echoDecodeAddressListField=D;g.echoDecodeObjectIdListField=E}),98);
__d("EchoEncodingUtils",["EchoConstants","EchoMessage","FBLogger","MAWMsgType","WABase64"],(function(a,b,c,d,e,f,g){"use strict";var h=new Set(['"',"\\","\n","\r","\0"]),i=new Set(["\0","\x01","\x02","\x03","\x04","\x05","\x06","\x07","\b","\t","\n","\v","\f","\r","\x0e","\x0f","\x10","\x11","\x12","\x13","\x14","\x15","\x16","\x17","\x18","\x19","\x1a","\x1b","\x1c","\x1d","\x1e","\x1f",'"',"\\"]);function j(a,b){for(b of b)if(a.indexOf(b)>=0)return!0;return!1}function k(a,b,d){d===void 0&&(d=new Set());if(a.length<=0)throw c("FBLogger")("wmi_eb").mustfixThrow("The input string must be non-empty");var e=b;b==="conditional"&&(j(a,d)?e="always":e="never");if(e==="never")return a;b='"';for(d=0;d<a.length;d++){e=a[d];h.has(e)?(b+="\\",e==="\r"?b+="r":e==="\n"?b+="n":b+=e):b+=e}return b+'"'}function l(a){if(!Number.isSafeInteger(a))throw c("FBLogger")("wmi_eb").mustfixThrow("The input value must be a safe integer");return a.toString()}function m(a){var b="",c=a.displayName,e=a.localKey;a=a.transportKey;c!=null&&c.length>0&&(b+=k(c,"always")+" <");b+=k(e,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE)+"@"+a;c!=null&&c.length>0&&(b+=">");return b}function n(a,b,c){c!=null&&c.length!==0&&a.set(b,k(c,"conditional",i))}function a(a,b,c){if(c!=null){c=l(c);n(a,b,c)}}function b(a,b,c){if(c!=null){c=l(c?1:0);n(a,b,c)}}function e(a,b,c){c!=null&&a.set(b,m(c))}function f(a,b,c){if(c!=null){var d="";c.forEach(function(a,b){d+=m(a),b<c.length-1&&(d+=", ")});a.set(b,d)}}function o(a){var b="";a.forEach(function(a,c){b=b+c+": "+a+"\r\n"});return b}function p(a){return d("WABase64").encodeB64UrlSafe(a)}function q(a){switch(a){case d("MAWMsgType").MSG_TYPE.TEXT:return d("EchoMessage").EchoXMessageContentType.TEXT;case d("MAWMsgType").MSG_TYPE.IMAGE:return d("EchoMessage").EchoXMessageContentType.IMAGE;case d("MAWMsgType").MSG_TYPE.VIDEO:return d("EchoMessage").EchoXMessageContentType.VIDEO;case d("MAWMsgType").MSG_TYPE.PTT:return d("EchoMessage").EchoXMessageContentType.AUDIO;case d("MAWMsgType").MSG_TYPE.STICKER:return d("EchoMessage").EchoXMessageContentType.STICKER;case d("MAWMsgType").MSG_TYPE.GIF:return d("EchoMessage").EchoXMessageContentType.GIF;case d("MAWMsgType").MSG_TYPE.XMA:return d("EchoMessage").EchoXMessageContentType.XMA;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return d("EchoMessage").EchoXMessageContentType.DOCUMENT;case d("MAWMsgType").MSG_TYPE.REACTION:return d("EchoMessage").EchoXMessageContentType.REACTION;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SETTINGS;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SYNC_RESPONSE;case d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return d("EchoMessage").EchoXMessageContentType.MESSAGE_DELETE_FOR_ME;case d("MAWMsgType").MSG_TYPE.REVOKED:return d("EchoMessage").EchoXMessageContentType.UNSEND;case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return d("EchoMessage").EchoXMessageContentType.GROUP_INVITES;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return d("EchoMessage").EchoXMessageContentType.BUMP;default:return d("EchoMessage").EchoXMessageContentType.UNKNOWN}}g.echoSetStringField=n;g.echoSetIntField=a;g.echoSetBooleanField=b;g.echoSetAddressField=e;g.echoSetAddressListField=f;g.echoEncodeFields=o;g.convertMediaKeyToString=p;g.convertDbMsgTypeToXMessageContentType=q}),98);
__d("EchoMessage",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","EchoMessageMediaFieldUtils","EchoMessageMediaGroupFieldUtil","EchoMessageQuoteFieldUtils","EchoMessageReceiptStatusFieldUtils","EchoMessageXMAFieldUtils","FBLogger","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o="Message-ID",p="Thread-ID",q="Sort-Order",r="Display-Timestamp",s="Authoritative-Timestamp",t="From",u="Text",v="Text-Size",w="Send-Error",x="Is-Tombstoned",y="Expire-Timestamp",z="Delete-Timestamp",A="Ephemeral-Duration",B="Message-Content-Type",C="X-Message-Content-Type",D="Message-Content-Subtype",E="Is-Forwarded",F="X-Offline-Threading-ID",G="X-Thread-ID",H="X-Message-Placeholder-Type",I="Reactions",J="Reaction-Authoritative-Timestamps",K="X-Reaction-Offline-Threading-IDs",L="Echo-Serialization-Origin",M="Revoke-Sent-Timestamp",N="Revoke-Unsent-Timestamp",O="Edit-Count",P="Edit-Contents-",Q="Edit-Timestamps-";f="Group-ID";var R="Group-Index",S="Group-Size",T="Receiver-Fetch-Id",U="Message-Ephemerality-Type",V=1,W=(b=b("$InternalEnum"))({NONE:"none",SMALL:"small",MEDIUM:"medium",LARGE:"large"}),X=b({NONE:"none",UNSEND:"unsend"}),Y=b({DECRYPTION_FAILURE:"decryption_failure",UNSUPPORTED_NEEDS_UPDATE:"unsupported_needs_update",TEXT:"text",ADMIN_MESSAGE:"admin_message",MEDIA:"media",XMA:"xma",NULL_STATE:"null_state",PLACEHOLDER:"placeholder"}),aa=b({UNKNOWN:"unknown",TEXT:"text",IMAGE:"image",VIDEO:"video",AUDIO:"audio",STICKER:"sticker",GIF:"gif",URL:"url",EPHEMERAL_SETTINGS:"ephemeral_settings",LOCATION:"location",DOCUMENT:"document",UNSEND:"unsend",SCREENSHOT_ACTION:"screenshot_action",REACTION:"reaction",XMA:"xma",VISUAL_MESSAGE_VIDEO:"visual_message_video",VISUAL_MESSAGE_IMAGE:"visual_message_image",VISUAL_MESSAGE_ACTION:"visual_message_action",SCREEN_RECORDING_ACTION:"screen_recording_action",MESSAGE_DELETE_FOR_ME:"message_delete_for_me",ENCRYPTED_BACKUP_NEW_DEVICE_ENROLLMENT:"encrypted_backup_new_device_enrollment",SENDER_KEY:"sender_key",DELETE_THREAD:"delete_thread",READ_THREAD:"read_thread",UNREAD_THREAD:"unread_thread",REACTION_UNSEND:"reaction_unsend",GROUP_INVITES:"group_invites",EPHEMERAL_SYNC_RESPONSE:"ephemeral_sync_response",BUMP:"bump"}),Z=b({NO_PLACEHOLDER:"0",DECRYPTION_FAILURE:"-1",CLIENT_NOT_SUPPORTED_NEED_UPDATE:"-2",UNAVIALABLE_DEVICE:"-3"}),$=b({UNKNOWN:"Unknown",WEB:"Web",MOBILE:"Mobile"});function a(a){var b=new Map();ia(b,a);"mediaData"in a&&a.mediaData&&d("EchoMessageMediaFieldUtils").echoMessageSetMediaMetadataFields(b,a.mediaData);return d("EchoEncodingUtils").echoEncodeFields(b)}function ba(a,b){var c,e=[],f=new Set();b.forEach(function(c,g,h){c=g.startsWith(P);h=g.startsWith(Q);if(c||h){h=g.slice(c?P.length:Q.length);if(!f.has(h)){f.add(h);c=(g=d("EchoDecodingUtils").echoDecodeStringField(b,""+P+h).result)!=null?g:"";g=((g=d("EchoDecodingUtils").echoDecodeIntField(b,""+Q+h).result)!=null?g:0)/1e3;e.push({messageId:h,originalMessageId:a,text:c,timestamp:g})}}});c=(c=d("EchoDecodingUtils").echoDecodeIntField(b,O).result)!=null?c:0;return{editCount:c,editHistory:e}}function e(a){a=d("EchoDecodingUtils").echoDecodeFields(a);if(a.size===0){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fieldsMap is empty for the echo message"])));return null}var b=d("EchoDecodingUtils").echoDecodeStringField(a,o),e=d("EchoDecodingUtils").echoDecodeStringField(a,p),f=d("EchoDecodingUtils").echoDecodeIntField(a,q),g=d("EchoDecodingUtils").echoDecodeIntField(a,r),O=d("EchoDecodingUtils").echoDecodeStringField(a,B),P=d("EchoDecodingUtils").echoDecodeStringField(a,C),Q=d("EchoDecodingUtils").echoDecodeStringField(a,D);if(b.success&&e.success&&f.success){b=b.result;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("The decoded messageId cannot be null");e=e.result;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("The decoded threadId cannot be null");O=O==null?void 0:O.result;if(O==null)throw c("FBLogger")("messenger_web").mustfixThrow("The decoded contentTypeString cannot be null");var R=ba(b,a),S=R.editCount;R=R.editHistory;Q={contentSubtype:fa(Q.result),contentType:da(O),displayTimestampMs:g.success?g.result:f.result,editCount:S,editHistory:R,messageId:b,sortOrderMs:f.result,threadId:e};O=ea(P.result);O!=null&&(Q.xContentType=O);g=d("EchoDecodingUtils").echoDecodeAddressField(a,t);g.success&&g.result!=null&&(Q.from=g.result);S=d("EchoDecodingUtils").echoDecodeNullableBooleanField(a,x);S.success&&S.result!=null&&(Q.isTombstoned=S.result);R=d("EchoDecodingUtils").echoDecodeStringField(a,u);R.success&&R.result!=null&&(Q.text=R.result);b=d("EchoDecodingUtils").echoDecodeStringField(a,v);if(b.success&&b.result!=null){f=ca(b.result);Q.textSize=f}e=d("EchoDecodingUtils").echoDecodeStringField(a,H);if(e.success&&e.result!=null){P=ga(e.result);Q.xMessagePlaceholderType=P}O=d("EchoDecodingUtils").echoDecodeStringField(a,w);O.success&&O.result!=null&&(Q.sendError=O.result);g=d("EchoDecodingUtils").echoDecodeNullableIntField(a,y);g.success&&g.result!=null&&(Q.expireTimestampMs=g.result);S=d("EchoDecodingUtils").echoDecodeNullableIntField(a,z);S.success&&S.result!=null&&(Q.deleteTimestampMs=S.result);R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,A);R.success&&R.result!=null&&(Q.ephemeralDurationInSec=R.result);b=d("EchoDecodingUtils").echoDecodeStringField(a,U);b.success&&b.result!=null&&(b.result==="view_once"&&(Q.viewOnce=!0));f=d("EchoDecodingUtils").echoDecodeNullableIntField(a,s);f.success&&f.result!=null&&(Q.authoritativeTimestampMs=f.result);e=d("EchoMessageReceiptStatusFieldUtils").echoMessageDecodeReceiptStatusDataFields(a);e.length>0&&(Q.receiptStatusList=e);P=d("EchoDecodingUtils").echoDecodeNullableBooleanField(a,E);P.success&&P.result!=null&&(Q.isForwarded=P.result);d("EchoMessageMediaGroupFieldUtil").decodeMessageMediaGroupFields(a,Q);O=d("EchoDecodingUtils").echoDecodeStringField(a,F);O.success&&O.result!=null&&(Q.xOfflineThreadingId=O.result);g=d("EchoDecodingUtils").echoDecodeStringField(a,G);g.success&&g.result!=null&&(Q.xThreadId=g.result);S=d("EchoDecodingUtils").echoDecodeStringField(a,L);S.success&&S.result!=null&&(Q.serializationOrigin=ha(S.result));R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,d("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION);Q.version=R.success&&R.result!=null?R.result:V;b=d("EchoDecodingUtils").echoDecodeAddressListField(a,I);b.success&&b.result!=null&&(Q.reactions=b.result);f=d("EchoDecodingUtils").echoDecodeAddressListField(a,J);f.success&&f.result!=null&&(Q.reactionAuthoritativeTimestampMs=f.result);e=d("EchoDecodingUtils").echoDecodeAddressListField(a,K);e.success&&e.result!=null&&(Q.reactionXOfflineThreadingIds=e.result);P=d("EchoMessageQuoteFieldUtils").echoMessageDecodeQuoteFields(a);P!=null&&(Q.quoteData=P);O=(Q==null?void 0:Q.contentType)===Y.XMA&&a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE)&&(a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID)||a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS));g=a.has(T);if(a.has(T)){S=d("EchoMessageMediaFieldUtils").decodeReceiverFetchData(a);R=d("EchoDecodingUtils").echoDecodeStringField(a,T);b=R.result;f=R.success;S==null||!f||b==null?d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode media data for Receiver Fetch, Message origin: ",""])),Q.serializationOrigin):(Q.receiverFetchData=S,Q.receiverFetchId=b)}if(((Q==null?void 0:Q.contentType)===Y.MEDIA||O)&&!g){e=d("EchoMessageMediaFieldUtils").echoMessageDecodeMediaDataFields(a,Q==null?void 0:Q.contentType,Q==null?void 0:Q.xContentType);P="[labyrinth_web] mandatory media data is missing from media message, msgId: "+Q.messageId+".";e!=null?(e.length!==1&&e.length!==2&&((Q==null?void 0:Q.contentType)===Y.MEDIA&&d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),P,Q.serializationOrigin),(Q==null?void 0:Q.contentType)===Y.XMA&&d("WALogger").WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),P,Q.serializationOrigin)),Q.mediaData=e[0],e.length===2&&(Q.previewMediaData=e[1])):((Q==null?void 0:Q.contentType)===Y.MEDIA&&d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),P,Q.serializationOrigin),(Q==null?void 0:Q.contentType)===Y.XMA&&d("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),P,Q.serializationOrigin))}if(Q.contentType===Y.PLACEHOLDER&&Q.contentSubtype===X.UNSEND){R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,M);R.success&&R.result!=null&&(Q.revokeSentTimestampMs=R.result);f=d("EchoDecodingUtils").echoDecodeNullableIntField(a,N);f.success&&f.result!=null&&(Q.revokeUnsentTimestampMS=f.result)}if(Q.contentType===Y.XMA){S=d("EchoMessageXMAFieldUtils").decodeXMAFields(a);if(S!=null)Q.xmaData=S;else{d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory xma data is missing from xma message, msgId: ",""])),Q.messageId);return null}}return Q}else return null}function ca(a){return(a=W.cast(a))!=null?a:W.NONE}function da(a){return(a=Y.cast(a))!=null?a:Y.TEXT}function ea(a){return aa.cast(a)}function fa(a){return(a=X.cast(a))!=null?a:X.NONE}function ga(a){return(a=Z.cast(a))!=null?a:Z.NO_PLACEHOLDER}function ha(a){return(a=$.cast(a))!=null?a:$.UNKNOWN}function ia(a,b){var c;(c=d("EchoEncodingUtils")).echoSetStringField(a,o,b.messageId);c.echoSetStringField(a,p,b.threadId);c.echoSetIntField(a,q,b.sortOrderMs);c.echoSetIntField(a,r,b.displayTimestampMs);c.echoSetIntField(a,s,b.authoritativeTimestampMs);c.echoSetAddressField(a,t,b.from);c.echoSetStringField(a,u,b.text);b.textSize!=null&&d("EchoEncodingUtils").echoSetStringField(a,v,b.textSize);b.xMessagePlaceholderType!=null&&d("EchoEncodingUtils").echoSetStringField(a,H,b.xMessagePlaceholderType);d("EchoEncodingUtils").echoSetStringField(a,w,b.sendError);d("EchoEncodingUtils").echoSetBooleanField(a,x,b.isTombstoned);d("EchoEncodingUtils").echoSetIntField(a,y,b.expireTimestampMs);d("EchoEncodingUtils").echoSetIntField(a,z,b.deleteTimestampMs);d("EchoEncodingUtils").echoSetIntField(a,A,b.ephemeralDurationInSec);b.contentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,B,b.contentType);b.xContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,C,b.xContentType);d("EchoMessageReceiptStatusFieldUtils").echoMessageSetReceiptStatusDataFields(a,b.receiptStatusList);d("EchoEncodingUtils").echoSetBooleanField(a,E,b.isForwarded);d("EchoEncodingUtils").echoSetStringField(a,F,b.xOfflineThreadingId);d("EchoEncodingUtils").echoSetStringField(a,G,b.xThreadId);d("EchoEncodingUtils").echoSetIntField(a,d("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION,b.version);b.contentSubtype!=null&&d("EchoEncodingUtils").echoSetStringField(a,D,b.contentSubtype);d("EchoEncodingUtils").echoSetAddressListField(a,I,b.reactions);d("EchoEncodingUtils").echoSetAddressListField(a,J,b.reactionAuthoritativeTimestampMs);d("EchoEncodingUtils").echoSetAddressListField(a,K,b.reactionXOfflineThreadingIds);d("EchoMessageQuoteFieldUtils").echoMessageSetQuoteFields(a,b);b.serializationOrigin!=null&&d("EchoEncodingUtils").echoSetStringField(a,L,b.serializationOrigin);b.revokeSentTimestampMs!=null&&d("EchoEncodingUtils").echoSetIntField(a,M,b.revokeSentTimestampMs);b.revokeUnsentTimestampMS!=null&&d("EchoEncodingUtils").echoSetIntField(a,N,b.revokeUnsentTimestampMS);d("EchoMessageMediaGroupFieldUtil").echoMessageSetMediaGroupFields(a,b);c=b.xmaData;c!=null&&d("EchoMessageXMAFieldUtils").echoMessageSetXMAFields(a,c);((c=b.editHistory)==null?void 0:c.length)>0&&(d("EchoEncodingUtils").echoSetIntField(a,O,b.editCount),b.editHistory.forEach(function(b){var c=b.messageId;c!=null&&(d("EchoEncodingUtils").echoSetStringField(a,P+c,b.text),d("EchoEncodingUtils").echoSetIntField(a,Q+c,b.timestamp*1e3))}));b.receiverFetchId!=null&&d("EchoEncodingUtils").echoSetStringField(a,T,b.receiverFetchId)}g.ECHO_SERIALIZATION_ORIGIN=L;g.ECHO_MESSAGE_FIELD_NAME_EDIT_COUNT=O;g.ECHO_MESSAGE_FIELD_NAME_EDIT_CONTENT_PREFIX=P;g.ECHO_MESSAGE_FIELD_NAME_EDIT_TS_PREFIX=Q;g.ECHO_MESSAGE_FIELD_GROUP_ID=f;g.ECHO_MESSAGE_FIELD_GROUP_INDEX=R;g.ECHO_MESSAGE_FIELD_GROUP_SIZE=S;g.ECHO_MESSAGE_FIELD_RECEIVER_FETCH_ID=T;g.ECHO_MESSAGE_FIELD_NAME_EPHEMERALITY_TYPE=U;g.ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION=V;g.MessageTextSize=W;g.EchoMessageContentSubtype=X;g.EchoMessageContentType=Y;g.EchoXMessageContentType=aa;g.EchoMessagePlaceholderType=Z;g.EchoSerializationOriginType=$;g.encodeEchoMessage=a;g.decodeEchoMessage=e}),98);
__d("EchoMessageMediaFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","EchoMessage","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w="X-Object-Id",x="X-Attachment-Object-Ids",y="Attachment-Type",z="Content-Type",A="X-Encrypted-Hash",B="X-Attachment-Type",C="X-Backup-Ent-Fbid",D="X-Backup-Status",E="X-Content-Type",F="X-Direct-Path",G="Height",H="X-Media-Key",I="X-Media-Key-Timestamp",J="Playable-Duration",K="Preview-Height",L="Preview-Content-Type",M="Preview-Width",N="Size",O="Width",P="X-Plaintext-Hash",Q="File-Name",R="Header-Attribution-Content-Type",S=(f=b("$InternalEnum"))({IMAGE:"image",STICKER:"sticker",VIDEO:"video",GIF:"animated_image",PTT:"audio",XMA:"xma",DOCUMENT:"document"}),T=f({IMAGE_JPEG:"image/jpeg",IMAGE_PNG:"image/png",STICKER:"image/webp",GIF:"image/gif",AUDIO_MP4:"audio/mp4",AUDIO_WAV:"audio/wav",XMA:"xma"}),U=f({INVALID:"-1",IMAGE:"0",PTT:"1",AUDIO:"2",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",PROFILE_PICTURE:"7",APP_STATE:"8",HISTORY_SYNC:"9",THUMBNAIL_IMAGE:"10",THUMBNAIL_VIDEO:"11",THUMBNAIL_GIF:"12",THUMBNAIL_DOCUMENT:"13",THUMBNAIL_LINK:"14",NOVI_IMAGE:"15",NOVI_VIDEO:"16",KYCID:"17",WAFFLE_IMAGE:"18",WAFFLE_VIDEO:"19",WAFFLE_GIF:"20",PAYMENT_BG_IMAGE:"21",XMA_IMAGE:"22",PAYMENT_BR_DOCUMENT:"23",BIZ_COVER_PHOTO:"24",MESSENGER_PREVIEW:"25"}),V=f({FULL:"full",PREVIEW:"preview"});function W(a,b){var c=a.attachmentObjectId,e=a.attachmentType,f=a.backupEntFbid,g=a.directPath,n=a.filename,o=a.encryptedHash,p=a.height,q=a.mediaBackupStatus,r=a.mediaContentType,s=a.mediaKey,t=a.mediaKeyTimestamp,u=a.mediaPlayableDuration,v=a.plaintextHash,w=a.previewContentHeight,x=a.previewContentType,y=a.previewContentWidth,z=a.size,A=a.width,B=a.xAttachmentType,C=a.xContentType,D=a.xmaData;a=a.mediaEntryData;if(c==null)d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment object id from required media metadata fields, msgId: ",""])),b);else if(e==null)d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment type from required media metadata fields, msgId: ",""])),b);else if(g==null)d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing direct path field from required media metadata fields, msgId: ",""])),b);else if(v==null)d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing plaintextHash field from required media metadata fields, msgId: ",""])),b);else if(C==null)d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xContentType field from required media metadata fields, msgId: ",""])),b);else if(B==null)d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xAttachmentType field from required media metadata fields, msgId: ",""])),b);else return{attachmentObjectId:c,attachmentType:e,backupEntFbid:f,directPath:g,encryptedHash:o,filename:n,height:p,mediaBackupStatus:q,mediaContentType:r,mediaEntryData:a,mediaKey:s,mediaKeyTimestamp:t,mediaPlayableDuration:u,plaintextHash:v,previewContentHeight:w,previewContentType:x,previewContentWidth:y,size:z,width:A,xAttachmentType:B,xContentType:C,xmaData:D}}function a(a,b){var c;(c=d("EchoEncodingUtils")).echoSetStringField(a,w,b.attachmentObjectId);c.echoSetStringField(a,y,b.attachmentType);c.echoSetStringField(a,P,b.plaintextHash);c.echoSetStringField(a,A,b.encryptedHash);c.echoSetIntField(a,N,b.size);c.echoSetStringField(a,H,b.mediaKey);c.echoSetIntField(a,I,b.mediaKeyTimestamp);c.echoSetStringField(a,F,b.directPath);b.mediaContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,z,b.mediaContentType);d("EchoEncodingUtils").echoSetIntField(a,O,b.width);d("EchoEncodingUtils").echoSetIntField(a,G,b.height);b.previewContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,L,b.previewContentType);b.headerAttributionContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,R,b.headerAttributionContentType);d("EchoEncodingUtils").echoSetIntField(a,M,b.previewContentWidth);d("EchoEncodingUtils").echoSetIntField(a,K,b.previewContentHeight);d("EchoEncodingUtils").echoSetIntField(a,J,b.mediaPlayableDuration);b.xAttachmentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,B,b.xAttachmentType);d("EchoEncodingUtils").echoSetStringField(a,E,b.xContentType);d("EchoEncodingUtils").echoSetStringField(a,C,b.backupEntFbid);d("EchoEncodingUtils").echoSetStringField(a,D,b.mediaBackupStatus);d("EchoEncodingUtils").echoSetStringField(a,Q,b.filename)}function c(a,b,c){var e={},f=!1,g=!1,h=!1;if(ba(a)){var i=$(a,b,c);if(i==null){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: primary attachment object id is null. msgType: "," mediaType: ",""])),b,c);return null}i.length!==2&&d("WALogger").ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to get primary and secondary attachment object ids"])));c=!1;var j=!1,k=i[0];i=i[1];var l={};f=Z(a,e,k);c=Z(a,l,i);g=Y(a,e,b,k,k);j=Y(a,l,b,i,k);h=X(a,e,k);k=X(a,l,i);if(!f||!g||!h||!c||!j||!k)return null;i=d("EchoDecodingUtils").echoDecodeStringField(a,"X-Offline-Threading-ID").result;c=W(e,i);j=W(l,i);if(c!=null&&j!=null)return[c,j]}else{f=Z(a,e);g=Y(a,e,b);h=X(a,e);if(!f||!g||!h)return null;k=W(e);if(k!=null)return[k]}return null}function X(a,b,c){var e,f=d("EchoDecodingUtils").echoDecodeStringField(a,"X-Offline-Threading-ID").result;e=(e=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?e:"";c=[{fieldName:"height",id:G},{fieldName:"width",id:O},{fieldName:"size",id:N},{fieldName:"previewContentHeight",id:K},{fieldName:"previewContentWidth",id:M},{fieldName:"mediaKeyTimestamp",id:c!=null?c+"-"+I:I}];var g=[{attachmentTypes:[U.VIDEO,U.AUDIO],fieldName:"mediaPlayableDuration",id:J}];for(g of g){var h=g.attachmentTypes,i=g.fieldName,j=g.id;j=d("EchoDecodingUtils").echoDecodeIntField(a,j);var k=j.result;j=j.success;if(j&&k!=null)b[i]=k;else if(!(b.xAttachmentType!=null&&!aa(h,b.xAttachmentType)||b.attachmentType===S.XMA)){d("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. xAttachmentType: ",", AttachmentType: ",". EchoOrigin: "," xOfflineThreadingId: ",""])),i,b.xAttachmentType,b.attachmentType,e,f);return!1}}c.map(function(f){var c=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeIntField(a,f);var e=f.result;f=f.success;f&&e!=null&&(b[c]=e)});return!0}function Y(a,b,c,e,f){var g,h=d("EchoDecodingUtils").echoDecodeStringField(a,"X-Offline-Threading-ID").result,i,j;g=(g=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?g:"";var k=[{fieldName:"filename",id:Q}];e!=null&&f!=null?(b.attachmentObjectId=e,i=[{fieldName:"plaintextHash",id:e+"-"+P},{fieldName:"directPath",id:e+"-"+F},{fieldName:"xContentType",id:e+"-"+E}],k.push({fieldName:"mediaKey",id:e+"-"+H}),j=f+"-"+C,e=e+"-"+A):(i=[{fieldName:"attachmentObjectId",id:w},{fieldName:"plaintextHash",id:P},{fieldName:"directPath",id:F},{fieldName:"xContentType",id:E}],k.push({fieldName:"mediaKey",id:H}),j=C,e=A);k.push({fieldName:"backupEntFbid",id:j});k.push({fieldName:"mediaContentType",id:z});k.push({fieldName:"encryptedHash",id:e});j=f!=null?f+"-"+D:D;k.push({fieldName:"mediaBackupStatus",id:j});e=[];for(f of i){j=f.fieldName;i=f.id;i=d("EchoDecodingUtils").echoDecodeStringField(a,i);var l=i.result;i=i.success;i&&l!=null?b[j]=l:e.push(j)}if(e.length>0){i=e.join(", ");c===d("EchoMessage").EchoMessageContentType.XMA?d("WALogger").WARN(q||(q=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: ",""])),i,b.attachmentType,g):d("WALogger").ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""])),i,b.attachmentType,g,h);return!1}k.map(function(e){var f=e.fieldName;e=e.id;e=d("EchoDecodingUtils").echoDecodeStringField(a,e);var c=e.result;e=e.success;e&&c!=null&&(b[f]=c)});return!0}function Z(a,b,c){var e,f=d("EchoDecodingUtils").echoDecodeStringField(a,"X-Offline-Threading-ID").result;e=(e=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?e:"";var g=d("EchoDecodingUtils").echoDecodeStringField(a,y);g=g.result==="file"?S.DOCUMENT:S.cast(g.result);g!=null&&(b.attachmentType=g);var h=d("EchoDecodingUtils").echoDecodeStringField(a,L);h=T.cast(h.result);h!=null&&(b.previewContentType=h);var i=d("EchoDecodingUtils").echoDecodeStringField(a,R);i=i.result;i!=null&&(b.headerAttributionContentType=i);i=d("EchoDecodingUtils").echoDecodeStringField(a,c!=null?c+"-"+B:B);i.success&&i.result!=null&&(a=ca(i.result),a!=null&&(b.xAttachmentType=a));if(g!=null&&(h!=null||g===S.DOCUMENT||g===S.PTT))return!0;else d("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing enum fields from media fields: attachmentType: "," mediaPreviewContentType: "," mediaAttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""])),g,h,i,e,f);return!1}function aa(a,b){return a.reduce(function(a,c){return a||c===b},!1)}function ba(a){return a.has(x)}function $(a,b,c){var e=d("EchoDecodingUtils").echoDecodeObjectIdListField(a,x),f=e.result;e=e.success;if(!e||f==null||f.length!==2){d("WALogger").ERROR(t||(t=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: can not parse objects ids. "," msgType: "," mediaType: ",""])),f,b,c);return null}e=f.find(function(b){b=b+"-"+D;b=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=b.result;b=b.success;if(b&&c!=null)return!0});if(e!=null){b=e===f[0]?f[1]:f[0];return[e,b]}e=f.find(function(b){b=b+"-"+E;b=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=b.result;b=b.success;if(b&&c!=null&&V.cast(c)===V.FULL)return!0});if(e!=null){c=e===f[0]?f[1]:f[0];return[e,c]}return f}function ca(a){var b=U.cast(a);b==null&&d("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid media attachment type: ",""])),a);return b!=null?b:U.INVALID}function e(a){var b={};b=Z(a,b);if(!b)return null;b=d("EchoDecodingUtils").echoDecodeStringField(a,z);var c=d("EchoDecodingUtils").echoDecodeIntField(a,G),e=d("EchoDecodingUtils").echoDecodeIntField(a,O);a=d("EchoDecodingUtils").echoDecodeStringField(a,y);if(!b.success||!c.success||!e.success||!a.success||b.result==null||c.result==null||e.result==null||a.result==null){d("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing media fields for receiver fetch"])));return null}return{mimetype:b.result,previewHeight:c.result,previewWidth:e.result,type:a.result}}g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID=w;g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS=x;g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE=y;g.AttachmentType=S;g.EchoMessageMediaPreviewType=T;g.EchoMessageActMediaAttachmentType=U;g.convertMediaMetadataDetailsToMediaMetadata=W;g.echoMessageSetMediaMetadataFields=a;g.echoMessageDecodeMediaDataFields=c;g.setMediaIntFields=X;g.setMediaEnumFields=Z;g.getAttachmentObjectIdsFromMultiBlobMediaMsg=$;g.decodeReceiverFetchData=e}),98);
__d("EchoMessageMediaGroupFieldUtil",["EchoDecodingUtils","EchoEncodingUtils","EchoMessage"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){b.groupId!=null&&d("EchoEncodingUtils").echoSetStringField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID,b.groupId),b.groupIndex!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX,b.groupIndex),b.groupSize!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE,b.groupSize)}function b(a,b){var c=d("EchoDecodingUtils").echoDecodeStringField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID);c.success&&c.result!=null&&(b.groupId=c.result);c=d("EchoDecodingUtils").echoDecodeIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX);c.success&&c.result!=null&&(b.groupIndex=c.result);c=d("EchoDecodingUtils").echoDecodeIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE);c.success&&c.result!=null&&(b.groupSize=c.result)}g.echoMessageSetMediaGroupFields=a;g.decodeMessageMediaGroupFields=b}),98);
__d("EchoMessageQuoteFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils"],(function(a,b,c,d,e,f,g){"use strict";var h="Reply-Message-Id",i="Reply-Message-Sender",j="Reply-Sort-Order",k="Reply-Type",l="Reply-Status",m=b("$InternalEnum").Mirrored(["BUMP"]),n=b("$InternalEnum")({VALID:"valid"});function a(a){var b={quoteMessageId:"<not set>",quoteMessageSender:{localKey:"<not set>",transportKey:"<not set>"},quoteSortOrderInMs:0},c=o(a,b),d=p(a,b),e=q(a,b);a=r(a,b);return!c||!d||!e||!a?null:b}function c(a,b){b=b.quoteData;if(b==null)return;d("EchoEncodingUtils").echoSetStringField(a,h,b.quoteMessageId);d("EchoEncodingUtils").echoSetAddressField(a,i,b.quoteMessageSender);d("EchoEncodingUtils").echoSetIntField(a,j,b.quoteSortOrderInMs);b.status!=null&&d("EchoEncodingUtils").echoSetStringField(a,l,b.status);b.replyType!=null&&d("EchoEncodingUtils").echoSetStringField(a,k,b.replyType)}function o(a,b){var c=[{fieldName:"quoteMessageSender",id:i}];for(c of c){var e=c.fieldName,f=c.id;f=d("EchoDecodingUtils").echoDecodeAddressField(a,f);var g=f.result;f=f.success;if(f&&g!=null)b[e]=g;else return!1}return!0}function p(a,b){var c=[{fieldName:"quoteMessageId",id:h}];for(c of c){var e=c.fieldName,f=c.id;f=d("EchoDecodingUtils").echoDecodeStringField(a,f);var g=f.result;f=f.success;if(f&&g!=null)b[e]=g;else return!1}return!0}function q(a,b){var c=[{fieldName:"quoteSortOrderInMs",id:j}];for(c of c){var e=c.fieldName,f=c.id;f=d("EchoDecodingUtils").echoDecodeIntField(a,f);var g=f.result;f=f.success;if(f&&g!=null)b[e]=g;else return!1}return!0}function r(a,b){var c=d("EchoDecodingUtils").echoDecodeStringField(a,k);c=m.cast(c.result);c!=null&&(b.replyType=c);c=d("EchoDecodingUtils").echoDecodeStringField(a,l);a=n.cast(c.result);a!=null&&(b.status=a);return!0}g.EchoMessageQuoteReplyType=m;g.EchoMessageQuoteStatus=n;g.echoMessageDecodeQuoteFields=a;g.echoMessageSetQuoteFields=c}),98);
__d("EchoMessageReceiptStatusFieldUtils",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i="Receipt-Status",j="Receipt-Timestamp",k=b("$InternalEnum")({UNKNOWN:"unknown",SENDING:"sending",SERVER_RECEIVED:"server_received",DELIVERED:"delivered",READ:"read",ERROR:"error",NON_RETRYABLE_ERROR:"non_retryable_error"});function a(a,b){if(b==null||b.length===0)return;b.forEach(function(b){d("EchoEncodingUtils").echoSetStringField(a,d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(b.address,i),b.status),b.timestampMs!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(b.address,j),b.timestampMs)})}function c(a){var b=[];l(a).forEach(function(c){var e=d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(c,i);e=d("EchoDecodingUtils").echoDecodeStringField(a,e);if(e.success){e=(e=k.cast(e.result))!=null?e:k.UNKNOWN;var f=d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(c,j);f=d("EchoDecodingUtils").echoDecodeNullableIntField(a,f);f.result!=null?b.push({address:c,status:e,timestampMs:f.result}):b.push({address:c,status:e})}});return b}function l(a){var b=new Set();for(a of a.keys())if(a.includes(i))try{var c=a.split("@"),e=c[0];c=m(c[1]);b.add({localKey:e,transportKey:c})}catch(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error occurred while decoding participants from echo doc, error: ",""])),a)}return Array.from(b)}function m(a){a=a.split(i);return a[0].split("-")[0]}g.MessageReceiptStatus=k;g.echoMessageSetReceiptStatusDataFields=a;g.echoMessageDecodeReceiptStatusDataFields=c}),98);
__d("EchoMessageXMAFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l="XMA-Default-CTA",m="XMA-Gating-Type",n="XMA-Header-Subtitle",o="XMA-Header-Title",p="XMA-Is-Tombstoned",q="XMA-Layout-Type",r="XMA-Max-Subtitle-Num-Lines",s="XMA-Max-Title-Num-Lines",t="XMA-Subtitle-Text",u="XMA-Target-Expiry",v="XMA-Target-ID",w="XMA-Target-Type",x="XMA-Target-Username",y="XMA-Title-Text",z="XMA-Content-Ref",A="XMA-Dataclass",B=b("$InternalEnum").Mirrored(["SINGLE","HSCROLL","VSTACK","PORTRAIT","STANDARD_DXMA","LIST_DXMA","GRID"]),C=b("$InternalEnum").Mirrored(["NONE","IG_STORY_PHOTO_MENTION","IG_SINGLE_IMAGE_POST_SHARE","IG_MULTIPOST_SHARE","IG_SINGLE_VIDEO_POST_SHARE","IG_STORY_PHOTO_SHARE","IG_STORY_VIDEO_SHARE","IG_CLIPS_SHARE","IG_IGTV_SHARE","IG_SHOP_SHARE","IG_PROFILE_SHARE","IG_STORY_PHOTO_HIGHLIGHT_SHARE","IG_STORY_VIDEO_HIGHLIGHT_SHARE","IG_STORY_REPLY","IG_STORY_REACTION","FB_FEED_SHARE","FB_STORY_REPLY","FB_STORY_SHARE","FB_STORY_MENTION","FB_FEED_VIDEO_SHARE","FB_GAMING_CUSTOM_UPDATE","FB_PRODUCER_STORY_REPLY","FB_PROFILE_DIRECTORY_ITEM","FB_FEED_POST_REACTION_REPLY","MSG_EXTERNAL_LINK_SHARE","MSG_RECEIVER_FETCH","RTC_AUDIO_CALL","RTC_VIDEO_CALL","RTC_MISSED_AUDIO_CALL","RTC_MISSED_VIDEO_CALL","RTC_GROUP_AUDIO_CALL","RTC_GROUP_VIDEO_CALL","FB_EVENT","FB_SHORT","MSG_LOCATION_SHARING","MSG_LOCATION_SHARING_V2","MSG_MEMORIES_SHARE"]),D=b("$InternalEnum").Mirrored(["NONE","PRIVATE","SENSITIVE","MISINFORMATION","MEDIA_LABEL","POST_COVER","POST_LABEL","WARNING_SCREENS","INFO","EYE_OFF","NEWS_OFF","WARNING"]);function a(a,b){b.xmaLayoutType!=null&&d("EchoEncodingUtils").echoSetStringField(a,q,b.xmaLayoutType),b.xmaTargetType!=null&&d("EchoEncodingUtils").echoSetStringField(a,w,b.xmaTargetType),d("EchoEncodingUtils").echoSetStringField(a,x,b.xmaTargetUsername),d("EchoEncodingUtils").echoSetStringField(a,v,b.xmaTargetId),b.xmaTargetExpiry!=null&&d("EchoEncodingUtils").echoSetIntField(a,u,b.xmaTargetExpiry),d("EchoEncodingUtils").echoSetStringField(a,l,b.xmaDefaultCTA),d("EchoEncodingUtils").echoSetStringField(a,o,b.xmaHeaderTitle),d("EchoEncodingUtils").echoSetStringField(a,n,b.xmaHeaderSubtitle),d("EchoEncodingUtils").echoSetStringField(a,y,b.xmaTitleText),d("EchoEncodingUtils").echoSetStringField(a,t,b.xmaSubtitleText),b.xmaMaxTitleNumLines!=null&&d("EchoEncodingUtils").echoSetIntField(a,s,b.xmaMaxTitleNumLines),b.xmaMaxSubtitleNumLines!=null&&d("EchoEncodingUtils").echoSetIntField(a,r,b.xmaMaxSubtitleNumLines),b.xmaGatingType!=null&&d("EchoEncodingUtils").echoSetStringField(a,m,b.xmaGatingType),b.xmaDataclass!=null&&d("EchoEncodingUtils").echoSetStringField(a,A,b.xmaDataclass),d("EchoEncodingUtils").echoSetBooleanField(a,p,b.xmaIsTombstoned),b.xmaContentRef!=null&&d("EchoEncodingUtils").echoSetStringField(a,z,b.xmaContentRef)}function c(a){var b=G(a,p);if(b==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xmaIsTombstoned from xma fields"])));return null}var c=D.cast(d("EchoDecodingUtils").echoDecodeStringField(a,m).result),e=B.cast(d("EchoDecodingUtils").echoDecodeStringField(a,q).result),f=C.cast(d("EchoDecodingUtils").echoDecodeStringField(a,w).result);return{xmaContentRef:E(a,z),xmaDataclass:E(a,A),xmaDefaultCTA:E(a,l),xmaGatingType:c,xmaHeaderSubtitle:E(a,n),xmaHeaderTitle:E(a,o),xmaIsTombstoned:b,xmaLayoutType:e,xmaMaxSubtitleNumLines:F(a,r),xmaMaxTitleNumLines:F(a,s),xmaSubtitleText:E(a,t),xmaTargetExpiry:F(a,u),xmaTargetId:E(a,v),xmaTargetType:f,xmaTargetUsername:E(a,x),xmaTitleText:E(a,y)}}function E(a,b){a=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields"])),b)}function F(a,b){a=d("EchoDecodingUtils").echoDecodeIntField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"])),b)}function G(a,b){a=d("EchoDecodingUtils").echoDecodeBooleanField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"])),b)}g.XMALayoutType=B;g.XMAContentType=C;g.XMAGatingType=D;g.echoMessageSetXMAFields=a;g.decodeXMAFields=c}),98);
__d("validateMAWMediaAndComposeEntryForProtoMsg",["FBLogger","WAMediaUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("DbMedia is null in validateMediaAndComposeEntryForProtoMsg");if(a!=null&&b.mediaId!=null){if(!b.msgIds.includes(a))throw c("FBLogger")("messenger_web").mustfixThrow("the media ("+b.mediaId+") is not linked to the msg ("+a+")");a=b.mediaEntries.get(a)}else a=b.mediaEntry;if(a==null)throw c("FBLogger")("messenger_web").mustfixThrow("media entry not found in validateMediaAndComposeEntryForProtoMsg");var d=b.plaintextHash;d=h(d,a);return[b,d]}function h(a,b){var e=d("WAMediaUtils").mediaEntryDataToRawData(a,b);a=["fileSha256","mediaKey","fileEncSha256","directPath","mediaKeyTimestamp"];b=a.filter(function(a){return e[a]==null});if(b.length>0)throw c("FBLogger")("messenger_web").mustfixThrow("missing fields in mediaEntryData: "+b.toString());return e}g.validateMAWMediaAndComposeEntryForProtoMsg=a;g.validateMediaEntry=h}),98);
__d("MAWAsArmadilloApplication",["FBLogger","MAWEncodeMediaTransportProtocol","MAWMsg","MAWMsgType","MAWVault","MAWXMAEncodeUtils","WAArmadilloApplication.pb","WAGlobals","WAJids","WATimeUtils","getErrorSafe","validateMAWMediaAndComposeEntryForProtoMsg"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,e,f){switch(a.type){case d("MAWMsgType").MSG_TYPE.XMA:if((b==null?void 0:b.xma)==null)throw c("FBLogger")("messenger_web").mustfixThrow("XMA content should have XMA payload");b=d("MAWXMAEncodeUtils").encodeXMA(a,b);return b;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return i(a,e);case d("MAWMsgType").MSG_TYPE.RAVEN:return l(a,f);case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return j(a);default:throw c("FBLogger")("messenger_web").mustfixThrow(a.type+" should not be handled as ArmadilloApplication")}}function i(a,b){var c;if(a.type!==d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE||((c=a.quote)==null?void 0:c.content)==null||b==null)return null;c=a.quote.content;var e=d("WAJids").interpretAndValidateJid(b),f=d("WAJids").isAuthorMe(a.author)?d("WAGlobals").getMyUserJid():a.author,g=d("WAJids").isAuthorMe(c.author)?d("WAGlobals").getMyUserJid():c.author;function h(){if(e.jidType==="msgrUser")return g;return e.jidType==="group"?e.groupJid:null}function i(){if(f===g)return null;return e.jidType==="group"?g:null}b=h();h=i();if(b==null)return null;if(a)return{payload:{content:{bumpExistingMessage:{key:{fromMe:f===g,id:c.externalId,participant:h,remoteJid:b}}}}}}function b(a){var b,c,e;b=(b=a.quote)==null?void 0:b.content;var f=b==null||(c=b.msgContent)==null?void 0:c.content,g=b==null?void 0:b.expirationTs;a=a==null||(e=a.msgContent)==null?void 0:e.content;if(b==null||f==null||a==null)return null;b=g!=null?d("WATimeUtils").castUnixTimeToMillisTime(g):void 0;return{payload:{content:{noteReplyMessage:{noteText:{text:d("MAWVault").unvault(f)},noteTimestampMs:b,textContent:{text:d("MAWVault").unvault(a)}}}}}}function j(a){var b=a.ravenActionToMsgExternalId;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("msg ravenActionToMsgExternalId is null in encodeRavenActionMessage");var e=Number(a.actionType),f;if(e===0)f=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.PLAYED;else if(e===1)f=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.SCREENSHOT;else if(e===2)f=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.FORCE_DISABLE;else throw c("FBLogger")("messenger_web").mustfixThrow("msg actionType is not in enum in encodeRavenActionMessage");e=a.actionTimestamp==null?Date.now():d("WATimeUtils").castUnixTimeToMillisTime(a.actionTimestamp);a={actionTimestamp:e,actionType:f,key:{id:b}};return{payload:{content:{ravenActionNotifMessage:a}}}}function k(a){switch(a){case d("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE:return 0;case d("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY:return 1;case d("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT:return 2}}function l(a,b){if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("media is null in encodeRavenMessage");var e;try{b=d("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(a.msgId,b);e=b[0];b=b[1]}catch(a){var f=c("getErrorSafe")(a);c("FBLogger")("messenger_web").DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Media entry is invalid, fallback to the placeholder: ",""])),f.message);e=void 0;b=void 0}if(e==null||b==null)return{payload:{content:{ravenMessageMsgr:{ephemeralType:k(a.ravenEphemeralType)}}}};switch(a.ravenMediaType){case d("MAWMsg").MAWRavenMsgMediaType.IMAGE:f=d("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToImageTransport(e,b);return{payload:{content:{ravenMessageMsgr:{ephemeralType:k(a.ravenEphemeralType),imageMessage:{payload:f,version:1}}}}};case d("MAWMsg").MAWRavenMsgMediaType.VIDEO:f=d("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToVideoTransport(e,b);return{payload:{content:{ravenMessageMsgr:{ephemeralType:k(a.ravenEphemeralType),videoMessage:{payload:f,version:1}}}}}}}g.asArmadilloApplication=a;g.encodeNoteReplyMessage=b}),98);
__d("MAWAsConsumerApplication",["FBLogger","I64","LSIntEnum","MAWDbMedia","MAWEncodeMediaTransportProtocol","MAWJids","MAWMsgType","MAWVault","WAAssertUnreachable","WAConsumerApplication.pb","WAGlobals","WAJids","WAMediaTransport.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b,e,f){switch(a.type){case d("MAWMsgType").MSG_TYPE.TEXT:return l(a);case d("MAWMsgType").MSG_TYPE.IMAGE:return m(a,b);case d("MAWMsgType").MSG_TYPE.VIDEO:return q(a,b);case d("MAWMsgType").MSG_TYPE.PTT:return s(a,b);case d("MAWMsgType").MSG_TYPE.REVOKED:return u(a.revokedExternalId);case d("MAWMsgType").MSG_TYPE.GIF:return q(a,b);case d("MAWMsgType").MSG_TYPE.STICKER:return o(a,b);case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return A(a,b);case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:case d("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return null;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:throw c("FBLogger")("messenger_web").mustfixThrow("Implemented ephemeral setting message in MAWAsConsumerApplication");case d("MAWMsgType").MSG_TYPE.XMA:throw c("FBLogger")("messenger_web").mustfixThrow("XMA content message is not consumer application. It should be addressed as ArmadilloApplication");case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("MAWMsgType").MSG_TYPE.ADMIN:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:case d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:throw c("FBLogger")("messenger_web").mustfixThrow("We do not support converting to protoMsg with "+a.type+" type","maw_db");case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:throw c("FBLogger")("messenger_web").mustfixThrow("Raven content message is not consumer application. It should be addressed as ArmadilloApplication");case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:throw c("FBLogger")("messenger_web").mustfixThrow("We do not support editing messages right now since the sending flow is not implemented yet. ");case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return v(a,e);case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:throw c("FBLogger")("messenger_web").mustfixThrow("Bump message is not consumer application. It should be addressed as ArmadilloApplication");case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return y(a,f);case d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:throw c("FBLogger")("messenger_web").mustfixThrow("We do not support group poll creation messages yet as the sending flow is not implemented.");case d("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:throw c("FBLogger")("messenger_web").mustfixThrow("We do not support group poll update messages yet as the sending flow is not implemented.");default:return c("WAAssertUnreachable")(a.type)}}function b(a,b){if(b==null)return j(a);else switch(b.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:return n(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.VIDEO:return r(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.PTT:return t(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.GIF:return r(a.msgId,b);case d("MAWDbMedia").MEDIA_TYPE.STICKER:return p(a.msgId,b);default:return null}}function j(a){var b=null;if(a.type===d("MAWMsgType").MSG_TYPE.REVOKED&&a.msgContent!=null&&a.msgContent.content!=null)b=a.msgContent.content;else if(a.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME&&a.msgContent!=null)b=a.msgContent;else return null;return{payload:{content:{messageText:{mentionedJid:[],text:d("MAWVault").unvault(b)}}}}}function k(a){if(a==null)return;a=a===1?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:a===2?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;return{specialTextSize:a}}function l(a){var b={payload:{content:{messageText:{commands:a.msgContent.commands,mentionedJid:a.msgContent.mentionedJids,text:d("MAWVault").unvault(a.msgContent.content)}}}};a=k(a.specialTextSize);a!=null&&(b.metadata=a);return b}function m(a,b){return n(a.msgId,b,a)}function n(a,b,c){a=d("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(a,b);b=a[0];a=a[1];return d("MAWEncodeMediaTransportProtocol").encodeValidatedImageMessage(b,a,c)}function e(a){function b(){var b=d("WAJids").validateGroupJid(a.threadJid);if(b!=null)return b;return d("WAJids").isAuthorMe(a.author)?a.threadJid:d("WAGlobals").getMyUserJid()}b=b();return{payload:{content:{editMessage:{key:{fromMe:!0,id:a.originalMsgExternalId,remoteJid:b},message:{mentionedJid:a.msgContent.mentionedJids,text:d("MAWVault").unvault(a.msgContent.content)},timestampMs:a.editTs*1e3}}}}}function o(a,b){return p(a.msgId,b)}function p(a,b){a=d("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(a,b);b=a[0];a=a[1];return d("MAWEncodeMediaTransportProtocol").encodeValidatedStickerMessage(b,a)}function q(a,b){return r(a.msgId,b)}function r(a,b){a=d("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(a,b);b=a[0];a=a[1];return d("MAWEncodeMediaTransportProtocol").encodeValidatedVideoMessage(b,a)}function s(a,b){return t(a.msgId,b)}function t(a,b){a=d("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(a,b);b=a[0];a=a[1];return d("MAWEncodeMediaTransportProtocol").encodeValidatedAudioMessage(b,a)}function u(a){return{payload:{applicationData:{revoke:{key:{fromMe:!0,id:a}}}}}}function f(a){var b=d("WAJids").isAuthorMe(a.reactToAuthor)?d("WAGlobals").getMyUserJid():a.reactToAuthor;function c(){var c=d("WAJids").isAuthorMe(a.author)?d("WAGlobals").getMyUserJid():a.author;return c===b?!0:!1}c=c();var e=d("WAJids").interpretAsGroupJid(a.threadJid)!=null;e={groupingKey:a.groupingKey==null?void 0:a.groupingKey,key:{fromMe:c,id:a.reactToExternalId,participant:e&&!c?b:void 0,remoteJid:a.threadJid},senderTimestampMs:a.senderTimestampMs,text:a.reaction==null?void 0:a.reaction};return{payload:{content:{reactionMessage:e}}}}function v(a,b){if(a.threadJid==null)throw c("FBLogger")("messenger_web").mustfixThrow("msg threadJid is null in encodeGroupInviteMessage");if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("DbGroupInvite is null in encodeGroupInviteMessage");var e=d("WAJids").interpretAsGroupJid(a.threadJid);if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("groupJid is null in encodeGroupInviteMessage");return{payload:{content:{groupInviteMessage:{groupJid:e,groupName:a.groupName,inviteCode:b.inviteCode,inviteExpiration:b.inviteExpirationTs}}}}}function w(a){return(h||(h=d("I64"))).equal(a.displayedContentTypes,(i||(i=d("LSIntEnum"))).ofNumber(1))||(h||(h=d("I64"))).equal(a.displayedContentTypes,(i||(i=d("LSIntEnum"))).ofNumber(256))||a.textHasLinks||a.isUnsent?x(a):null}function x(a){var b;b=(b=a.mentionIds)==null||(b=b.split(","))==null?void 0:b.map(d("MAWJids").toUserJid);return{payload:{content:{messageText:{mentionedJid:b!=null?b:[],text:a.text}}}}}function y(a,b){if(a.receiverFetchId==null)throw c("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch message without receiver fetch id");if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch message without receiver fetch info");switch(b.type){case"sticker":return z(b);default:throw c("FBLogger")("messenger_web").mustfixThrow("Unsupported receiver fetch type: "+b.type)}}function z(a){if(a.receiverFetchId==null)throw c("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch sticker message without receiver fetch id");a={ancillary:{accessibilityLabel:a.accessibilitySummaryText,height:a.previewHeight,isThirdParty:!1,receiverFetchId:a.receiverFetchId,width:a.previewWidth},integral:{receiverFetchId:a.receiverFetchId,transport:{ancillary:{mimetype:d("MAWEncodeMediaTransportProtocol").STICKER_MIME_TYPE,thumbnail:{thumbnailHeight:a.previewHeight,thumbnailWidth:a.previewWidth}},integral:{}}}};a=d("encodeProtobuf").encodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,a);return{payload:{content:{stickerMessage:{sticker:{payload:a.readBuffer(),version:1}}}}}}function A(a,b){return B(a.msgId,b)}function B(a,b){a=d("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(a,b);b=a[0];a=a[1];return d("MAWEncodeMediaTransportProtocol").encodeValidatedFileMessage(b,a)}g.asConsumerApplication=a;g.deletedMsgAsConsumerApplicationForSpamReporting=b;g.encodeConsumerApplicationMetadata=k;g.encodeEditMessage=e;g.encodeReactionMessage=f;g.asConsumerApplicationLSDb=w;g.encodeReceiverFetchStickerMessage=z;g.encodeFileMessage=A}),98);
__d("MAWAsMessageApplication",["I64","LSIntEnum","LSMessageReplySourceTypeV2","MAWAsArmadilloApplication","MAWAsConsumerApplication","MAWJids","MAWMsgType","WAArmadilloApplication.pb","WAAsMessageApplication","WAConsumerApplication.pb","WAFranking","WAGlobals","WAJids","WAMsgApplication.pb","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b,c,e,f,g){return d("WAAsMessageApplication").castToMessageApplicationBytes(d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,j(a,b,c,e,f,g)).readByteArrayView())}function j(a,b,c,e,f,g){var h,i;switch(a.type){case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:h=d("MAWAsArmadilloApplication").asArmadilloApplication(a,void 0,void 0,b);break;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:h=d("MAWAsArmadilloApplication").asArmadilloApplication(a,void 0,f);break;case d("MAWMsgType").MSG_TYPE.XMA:h=d("MAWAsArmadilloApplication").asArmadilloApplication(a,e);break;default:i=d("MAWAsConsumerApplication").asConsumerApplication(a,b,c,g)}var j,k;f=a.forwardingScore!=null?a.forwardingScore:0;e=a.isForwarded!=null?a.isForwarded:!1;if(a.quote!=null){b=a.quote;j={participant:b.content.author===d("WAJids").AUTHOR_ME?d("WAGlobals").getMyDeviceJid():b.content.author,stanzaId:b.content.externalId}}if(a.ephemeralSetting){c=a.ephemeralSetting;a.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?k={ephemeralExpiration:c.ephemeralExpirationInSec,isEphemeralSettingReset:a.isEphemeralSettingReset}:k={ephemeralExpiration:c.ephemeralExpirationInSec,ephemeralSettingTimestamp:c.ephemeralLastUpdatedOrSetTimestamp*1e3}}g={metadata:{chatEphemeralSetting:k,forwardingScore:f,frankingKey:o(a.reportingMeta),frankingVersion:d("WAFranking").getFrankingVersion(),groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize,isForwarded:e,quotedMessage:j}};if(i!=null){b=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,i);g.payload={subProtocol:{consumerMessage:{payload:b.readBuffer(),version:1}}}}else if(h!=null){c=d("encodeProtobuf").encodeProtobuf(d("WAArmadilloApplication.pb").ArmadilloSpec,h);g.payload={subProtocol:{armadillo:{payload:c.readBuffer(),version:1}}}}return g}function b(a){var b=d("MAWAsConsumerApplication").asConsumerApplicationLSDb(a),e,f,g=a.isForwarded!=null?a.isForwarded:!1,j=g?1:0;a.replySourceTypeV2&&!(h||(h=d("I64"))).equal(a.replySourceTypeV2,(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessageReplySourceTypeV2").NONE))&&a.replyToUserId!=null&&(e={participant:a.replyToUserId===d("WAJids").AUTHOR_ME?d("WAGlobals").getMyDeviceJid():d("MAWJids").toUserJid((h||(h=d("I64"))).to_string(a.replyToUserId)),stanzaId:a.messageId});j={metadata:{chatEphemeralSetting:f,forwardingScore:j,frankingKey:d("WAFranking").createFrankingKey(),frankingVersion:d("WAFranking").getFrankingVersion(),groupId:(j=a==null?void 0:a.groupId)!=null?j:void 0,groupIndex:a.groupIndex!=null?(h||(h=d("I64"))).to_float(a.groupIndex):void 0,groupSize:a.groupSize!=null?(h||(h=d("I64"))).to_float(a.groupSize):void 0,isForwarded:g,quotedMessage:e}};if(b!=null){a=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,b);j.payload={subProtocol:{consumerMessage:{payload:a.readBuffer(),version:1}}}}return j}function e(a){return d("WAAsMessageApplication").castToMessageApplicationBytes(d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,k(a)).readByteArrayView())}function k(a){a=d("MAWAsConsumerApplication").encodeReactionMessage(a);a=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,a);return{metadata:{frankingKey:d("WAFranking").createFrankingKey(),frankingVersion:d("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:a.readBuffer(),version:1}}}}}function f(a){var b=d("MAWAsArmadilloApplication").encodeNoteReplyMessage(a);if(b==null)return{metadata:{frankingKey:d("WAFranking").createFrankingKey(),frankingVersion:d("WAFranking").getFrankingVersion()}};a=a.ephemeralSetting;a=a?{ephemeralExpiration:a.ephemeralExpirationInSec,ephemeralSettingTimestamp:a.ephemeralLastUpdatedOrSetTimestamp*1e3}:void 0;b=d("encodeProtobuf").encodeProtobuf(d("WAArmadilloApplication.pb").ArmadilloSpec,b);return{metadata:{chatEphemeralSetting:a,frankingKey:d("WAFranking").createFrankingKey(),frankingVersion:d("WAFranking").getFrankingVersion()},payload:{subProtocol:{armadillo:{payload:b.readBuffer(),version:1}}}}}function l(a){return d("WAAsMessageApplication").castToMessageApplicationBytes(d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,m(a)).readByteArrayView())}function m(a){a=d("MAWAsConsumerApplication").encodeEditMessage(a);a=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,a);return{metadata:{frankingKey:d("WAFranking").createFrankingKey(),frankingVersion:d("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:a.readBuffer(),version:1}}}}}function n(a,b){var c;b=d("MAWAsConsumerApplication").deletedMsgAsConsumerApplicationForSpamReporting(a,b);if(b==null)return null;b=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,b);return{metadata:{frankingKey:o(a.reportingMeta),frankingVersion:((c=a.reportingMeta)==null?void 0:c.frankingVersion)!=null?(c=a.reportingMeta)==null?void 0:c.frankingVersion:d("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:b.readBuffer(),version:1}}}}}function o(a){if((a==null?void 0:a.frankingKey)!=null)return a.frankingKey;else return d("WAFranking").createFrankingKey()}g.encodeMessageApplication=a;g.asMessageApplication=j;g.asMessageApplicationLSDb=b;g.encodeReactionMessageApplication=e;g.asReactionMessageApplication=k;g.asNoteReplyMessageApplication=f;g.encodeEditMessageApplication=l;g.asEditMessageApplication=m;g.deletedMsgAsMessageApplicationForSpamReporting=n}),98);
__d("MAWXMAEncodeUtils",["MAWAsMessageApplication","MAWEncodeMediaTransportProtocol","MAWMsgType","MAWParseSubprotocolVersionConsts","MAWVault","WALogger","WAMsgApplication.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b,c){a=d("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(a,b);b=a[0];a=a[1];return{payload:d("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToImageTransport(b,a),version:c}}function a(a,b){var c=a.msgContent,e=a.msgId;a=c||{};c=a.commands;var f=a.content;a=a.mentionedJids;var g=b.associatedMessage,j=b.favicon,k=b.header,l=b.previews;b=b.xma;var m=null;if(g!=null)if(g.type!==d("MAWMsgType").MSG_TYPE.TEXT)d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Non-text associated message for the XMA content is not supported"])));else{g=d("MAWAsMessageApplication").asMessageApplication(g);g=d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,g);m={payload:g.readBuffer(),version:d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION}}g=k!=null&&e!=null?i(e,k,d("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION):null;k=j!=null&&e!=null?i(e,j,d("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION):null;j=l!=null&&e!=null?l.map(function(a){return i(e,a,d("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)}):null;l=b.defaultCTA==null?void 0:[b.defaultCTA].concat(b.ctas).filter(Boolean);return{payload:{content:{extendedContentMessage:{associatedMessage:m!=null?m:void 0,commands:c,contentRef:b.contentRef,ctas:l,favicon:k!=null?k:void 0,headerImage:g!=null?g:void 0,headerTitle:b.headerTitle,maxSubtitleNumOfLines:b.maxSubtitleNumOfLines,maxTitleNumOfLines:b.maxTitleNumOfLines,mentionedJid:a,messageText:f==null?void 0:d("MAWVault").unvault(f),overlayDescription:b.overlayDescription,overlayIconGlyph:b.overlayIconGlyph,overlayTitle:b.overlayTitle,previews:j!=null?j:[],sentWithMessageId:m?b.externalId:void 0,subtitleText:b.subtitleText,targetExpiringAtSec:b.targetExpiringAtSec,targetId:b.targetId,targetType:b.targetType,targetUsername:b.targetUsername,titleText:b.titleText,xmaDataclass:b.xmaDataclass,xmaLayoutType:b.xmaLayoutType}}}}}g.encodeXMA=a}),98);
__d("MAWBulkEditMsgsTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbEditMsgHistoryTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWUnsafeCoerce","MAWUserJidWrapper","WAJids","WAMsgMap","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=new Set(),e=[];b.forEach(function(a){var b=a.chatJid;a=a.msg;c.add(b);e.push(a.originalMsgExternalId)});return d("MAWDexieTable").dexieAll([a.messages.where("externalId").anyOf(e).toArray(),a.messages.where("quoteExternalId").anyOf(e).toArray(),a.editMsgHistory.where("originalMsgExternalId").anyOf(e).toArray()]).then(function(a){var b=a[0],c=a[1];a=a[2];return{editMsgHistory:a,originalMsgs:b,quoteMessages:c}})}function b(a,b,e){var f=e.editMsgHistory,g=e.originalMsgs,h=e.quoteMessages,j=g.reduce(function(a,b){var c=d("MAWJidUtils").toProtocolMsgId(b);return c==null?a:a.set(c,b)},new(d("WAMsgMap").MsgMap)());e=f.reduce(function(a,b){var c=d("MAWJidUtils").toProtocolMsgId(b);return c==null?a:a.set(c,b)},new(d("WAMsgMap").MsgMap)());g=i(b,{messageHistoriesToEdit:e,messagesToEdit:j});f=g[0];var k=g[1],l=g[2];return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,f).then(function(){var b=new(d("WAMsgMap").MsgMap)();k.entries().forEach(function(a){var e=a[0];a=a[1];var f=j.get(e);if(f==null){c("FBLogger")("messenger_web").warn("Cannot find the original msg for the edit action.");return}if(f.type!==d("WAMsgType").MSG_TYPE.TEXT&&f.type!==d("WAMsgType").MSG_TYPE.CIPHERTEXT)throw c("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",f.type);f=babelHelpers["extends"]({},f,{editCount:((f=f.editCount)!=null?f:0)+((f=l.get(e))!=null?f:0),msgContent:a.editMsgContent,type:d("WAMsgType").MSG_TYPE.TEXT});b.set(e,f)});var e=h.map(function(a){var e=a.quote,f=a.quoteExternalId,g=a.threadJid;if(e==null){c("FBLogger")("messenger_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",a.externalId);return}var h=e.content.author;h=d("MAWJidUtils").maybeToProtocolMsgId(h==="@me"?d("MAWUserJidWrapper").getMyUserJid():h,g,f);if(h==null)return;g=b.get(h);if(g==null)return;return babelHelpers["extends"]({},a,{quote:babelHelpers["extends"]({},e,{content:babelHelpers["extends"]({},e.content,{msgContent:babelHelpers["extends"]({},g.msgContent)})})})}).filter(Boolean);return a.messages.bulkPut(b.values().concat(e)).then(function(){b.values().forEach(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,a)})})})}).then(function(){e.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})})})})}function h(a,b){var e;switch(a.type){case d("WAMsgType").MSG_TYPE.TEXT:case d("WAMsgType").MSG_TYPE.EDIT_ACTION:return{author:a.author,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:(e=a.editMsgContent)!=null?e:d("MAWUnsafeCoerce").unsafeCoerce(a.msgContent),originalMsgExternalId:(e=a.originalMsgExternalId)!=null?e:a.externalId,sendStatus:d("MAWAckLevel").ACK.sent,specialTextSize:a.specialTextSize,threadJid:b};case d("WAMsgType").MSG_TYPE.CIPHERTEXT:return{author:a.author,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:{content:""},originalMsgExternalId:a.externalId,sendStatus:d("MAWAckLevel").ACK.sent,specialTextSize:a.specialTextSize,threadJid:b};default:a.type;throw c("FBLogger")("messenger_web").mustfixThrow("MAWBulkEditMsgsTxns::getMessageHistory: Unexpected msg type")}}function i(a,b){var e=b.messageHistoriesToEdit,f=b.messagesToEdit,g=[],i=new(d("WAMsgMap").MsgMap)(),j=new(d("WAMsgMap").MsgMap)();a.forEach(function(a){var b=a.chatJid;a=a.msg;var k=d("MAWJidUtils").maybeToProtocolMsgId(a.author,b,a.originalMsgExternalId);if(k==null)throw c("FBLogger")("messenger_web").mustfixThrow("[protocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",d("WAJids").isAuthorSystem(a.author),!!b,!!a.originalMsgExternalId);var l=d("MAWJidUtils").maybeToProtocolMsgId(a.author,b,a.externalId);if(l==null)throw c("FBLogger")("messenger_web").mustfixThrow("[editMsgProtocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",d("WAJids").isAuthorSystem(a.author),!!b,!!a.externalId);if(e.get(l)==null){g.push(h(a,b));l=(l=j.get(k))!=null?l:0;var m=f.get(k);j.set(k,l+1);if(e.get(k)==null&&l===0&&m!=null){if(m.type!==d("WAMsgType").MSG_TYPE.TEXT&&m.type!==d("WAMsgType").MSG_TYPE.CIPHERTEXT)throw c("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",m.type);g.push(h(m,b))}}l=i.get(k);m=l==null?void 0:l.serverTs;b=a==null?void 0:a.serverTs;(m==null||b==null||m<b)&&i.set(k,a)});return[g,i,j]}g.prepareDataForMessageEdit=a;g.bulkEditMsgs=b;g.getMessageHistory=h}),98);
__d("MAWBulkPutReactionsWithThreadUpdateTxn",["FBLogger","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWThreadSnippetBuildTxns","WAArrayGroupBy","WAJids","WAMsgMap","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.reduce(function(a,b){var c=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.reactToExternalId);if(c==null)return a;a.set(c,d("MAWDbReactionsTxns").coerceToReaction(b));return a},new(d("WAMsgMap").MsgMap)()).values()}function a(a,b,e){if(b.length===0)return d("MAWDexieTable").dexieResolve();b=h(b);var f=b.map(function(a){var b=e.get(a.threadJid);if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Should not have got here - expect thread to exist for flow");return a});b=d("WAArrayGroupBy").groupBy(f,function(a){a=a.threadJid;return a});b=b.map(function(b){var c=b[0];b=b[1];c=e.get(c);if(c==null||b.length===0)return null;var f=null;for(var g=b.length-1;g>=0;g--){f=d("MAWDbReaction").maybeCastToIncomingDbReaction(b[g]);if(f!=null)break}g=b.filter(function(a){return a.reaction==null});b=d("WAJids").interpretAsGroupJid(c.jid)!=null;return d("MAWThreadSnippetBuildTxns").getThreadChangesetForReactionChanges(a,c,{newestReaction:f,reactionsToClear:g},b)}).filter(Boolean);return d("MAWDexieTable").dexieAll(b).then(function(b){return d("MAWDexieTable").dexieAll([a.threads.bulkPut(b.map(function(a){a=a.thread;return a})),a.reactions.bulkPut(f)]).then(c("emptyFunction"))})}g.bulkPutReactionsWithThreadUpdates=a}),98);
__d("MAWDeletedReactionsCache",["WAMsgMap"],(function(a,b,c,d,e,f,g){"use strict";a=new(d("WAMsgMap").MsgMap)();g.DeletedReactionsCache=a}),98);
__d("MAWBulkWriteReactionsTxns",["FBLogger","LSMEBTaskCreationSource","MAWAuthor","MAWBridgeEventTransmitter","MAWBulkPutReactionsWithThreadUpdateTxn","MAWDbMsg","MAWDbReaction","MAWDbReactionsTxns","MAWDeletedReactionsCache","MAWDexieTable","MAWJidUtils","MAWODSProxy","MAWUseProtocolMsgIdForMsgId","WAArrayGroupBy","WAJids","WAOdsEnums","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=[],f=[];b.forEach(function(a){var b=a.chatJid;a=a.unstoredReaction;a=a.reactToExternalId;e.push(b);f.push(a)});return d("MAWDexieTable").dexieAll([a.threads.where("jid").anyOf(e).toArray(),a.messages.where("externalId").anyOf(f).toArray(),a.reactions.where("reactToExternalId").anyOf(f).toArray()]).then(function(e){var f=e[0],g=e[1];e=e[2];var i=new Map(f.map(function(a){return[a.jid,a]})),j=new Map(d("WAArrayGroupBy").groupBy(g,function(a){return a.externalId})),k=new Map(d("WAArrayGroupBy").groupBy(e,function(a){return a.reactToExternalId})),l=[],m=d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId();g=function(a){b.forEach(function(b){var e=b.chatJid;b=b.unstoredReaction;var f=b.author,g=b.externalId,n=b.groupingKey,o=b.reaction,p=b.reactToAuthor,q=b.reactToExternalId,r=b.senderTimestampMs,s=b.ts;e=i.get(e);if(e==null)return"missing_thread";var t=null;if(!m&&a!=null){var u=new Map(a),v=u.get(e.jid);if(v==null)throw c("FBLogger")("messenger_web").mustfixThrow("nextInChatReactionId should not be null");u.set(e.jid,v+1);t=d("MAWDbMsg").craftReactionId(e.chatId,v)}else t=d("MAWJidUtils").formatProtocolMsgIdFromExternalId(e.jid,g);u=k.get(b.reactToExternalId)||[];v=d("MAWDbReaction").findMatchingReaction(u,e.jid,f);if(v!=null&&d("MAWDbReaction").getReactionTimeMs(v)>d("MAWDbReaction").getReactionTimeMs(b))return"newer_reaction_exists";if(v!=null&&b.reaction==null){u={author:b.author,chat:b.threadJid,externalId:b.externalId};d("MAWDeletedReactionsCache").DeletedReactionsCache.set(u,v)}u=d("MAWAuthor").getAuthorUserJid(p);var w=j.get(b.reactToExternalId);if(w==null){var x=d("WAJids").threadIdForChatJid(e.jid);b.reactToExternalId===b.externalId?c("FBLogger")("messenger_web").warn("reactToExternalId is same as externalId"):c("gkx")("16596")||d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(b.reactToExternalId,x,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT_REACTIONS,e.jid)}b=h(e,u,w);x=d("MAWDbReaction").formatReactionForDb(e.jid,g,t,q,o,n,p,b==null&&m?d("MAWJidUtils").formatProtocolMsgIdFromExternalId(e.jid,q):b==null?void 0:b.msgId,s,f!=null?f:d("WAJids").AUTHOR_ME,v==null?void 0:v.rowId,void 0,r);l.push(x)});return{chatJidToDbThread:i,unstoredDbReactionsForInsertion:l}};if(!m){e=f.map(function(b){return d("MAWDbReactionsTxns").getNextReactionIdNumberForThread(a,b).then(function(a){return[b.jid,a]})});return d("MAWDexieTable").dexieAll(e).then(g)}return g(null)})}function h(a,b,e){e=(e=e==null?void 0:e.filter(function(c){return c.threadJid===a.jid&&b===d("MAWAuthor").getAuthorUserJid(c.author)}))!=null?e:[];e.length>1&&(c("FBLogger")("maw_mutation_validator").warn("%s matching duplicate messages found for a reaction",e.length),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_MUTATION_VALIDATOR,key:"match_reaction_to_message.invalid"}));return e[0]}function b(a,b){var c=b.chatJidToDbThread;b=b.unstoredDbReactionsForInsertion;return d("MAWBulkPutReactionsWithThreadUpdateTxn").bulkPutReactionsWithThreadUpdates(a,b,c)}g.prepareReactionsData=a;g.bulkWriteReactions=b}),98);
__d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMAGatingType.INFO:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO;case d("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF;case d("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF;case d("EchoMessageXMAFieldUtils").XMAGatingType.WARNING:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING;case d("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE;case d("EchoMessageXMAFieldUtils").XMAGatingType.NONE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE;default:d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaGatingType: ",""])),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE}}g.convertXMAGatingTypeToExtendedContentOverlayIconGlyph=a}),98);
__d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;case d("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT;case d("EchoMessageXMAFieldUtils").XMALayoutType.HSCROLL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.HSCROLL;case d("EchoMessageXMAFieldUtils").XMALayoutType.STANDARD_DXMA:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.STANDARD_DXMA;case d("EchoMessageXMAFieldUtils").XMALayoutType.LIST_DXMA:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.LIST_DXMA;case d("EchoMessageXMAFieldUtils").XMALayoutType.GRID:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.GRID;default:d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaLayoutType: ",""])),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE}}g.convertXMALayoutTypeToExtendedContentXMLLayoutType=a}),98);
__d("MAWConvertXMATargetTypeToExtendedContentTargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_SHORT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING_V2:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_MEMORIES_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_POST_REACTION_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY;default:d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaTargetType: ",""])),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE}}g.convertXMATargetTypeToExtendedContentTargetType=a}),98);
__d("MAWDexieCastToPromise",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;function a(a){return(g||(g=b("Promise"))).resolve(a)}function c(a){return a}f.dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING=a;f.promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING=c}),66);
__d("MAWEchoToProtobufConversionLoggingUtils",["QPLUserFlow","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){c("QPLUserFlow").start(c("qpl")._(521484676,"2684"),{annotations:b,instanceKey:a})}function b(a,b,d){c("QPLUserFlow").endFailure(c("qpl")._(521484676,"2684"),b,{annotations:d,instanceKey:a})}function d(a,b){c("QPLUserFlow").endSuccess(c("qpl")._(521484676,"2684"),{annotations:b,instanceKey:a})}function e(a,b,d){d&&c("QPLUserFlow").addAnnotations(c("qpl")._(521484676,"2684"),d,{instanceKey:a}),c("QPLUserFlow").addPoint(c("qpl")._(521484676,"2684"),b,{instanceKey:a})}g.startQplUserFlow=a;g.endFailure=b;g.endSuccess=d;g.addPoint=e}),98);
__d("MAWGetMsgForProtocolMsgIdTxn",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"getMsgForProtocolMsgIdTxn",function(a){return function(b){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(a){return a!=null?d("WAResultOrError").makeResult(a):d("WAResultOrError").makeError("message-not-found")})}});g.getMsgForProtocolMsgIdTxn=a}),98);
__d("MAWHandleXmaTransactionUtil",["MAWBridgeXMA","MAWDbChunkTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b){var c=!1;a!=null&&b.defaultPreviewMediaId===a.mediaId&&(c=await k(a));return d("MAWBridgeXMA").createBridgeXMA(a,b,{hasMedia:c,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}function b(a,b,c){return h(a,b,c).then(function(a){return d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:a})})}function h(a,b,c){a=c==null?d("MAWDexieTable").dexieResolve(!1):d("MAWDbChunkTxns").hasMediaChunk(a,c.hashedPlaintextHash);return a.then(function(a){return d("MAWBridgeXMA").createBridgeXMA(c,b,{hasMedia:a,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})})}function c(a,b,c,e,f){return i(a,b,c,e,f).then(function(a){return d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:a})})}function i(a,b,c,e,f){e=j(c,e,f,a);return e.then(function(a){var e=a.hasMedia,f=a.hasXmaFaviconMedia;a=a.hasXmaHeaderMedia;return d("MAWBridgeXMA").createBridgeXMA(c,b,{hasMedia:e,hasXmaFaviconMedia:f,hasXmaHeaderMedia:a})})}function j(a,b,c,e){if(a!=null||b!=null||c!=null){var f=[a,b,c].filter(Boolean).map(function(a){return a.hashedPlaintextHash});return d("MAWDbChunkTxns").hasMediaChunks(e,f).then(function(d){return{hasMedia:a!=null&&d.get(a.hashedPlaintextHash)===!0,hasXmaFaviconMedia:b!=null&&d.get(b.hashedPlaintextHash)===!0,hasXmaHeaderMedia:c!=null&&d.get(c.hashedPlaintextHash)===!0}})}else return d("MAWDexieTable").dexieResolve({hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}function e(a,b,c,e,f){return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(j(a,b,c,f).then(function(b){var c=b.hasMedia,f=b.hasXmaFaviconMedia;b=b.hasXmaHeaderMedia;return d("MAWBridgeXMA").createBridgeXMA(a,e,{hasMedia:c,hasXmaFaviconMedia:f,hasXmaHeaderMedia:b})}))}var k=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY},"MAWHandleXmaTransactionUtil.hasMediaChunkTransaction",function(a){return function(b){return d("MAWDbChunkTxns").hasMediaChunk(a,b.hashedPlaintextHash)}});g.checkMediaChunkTransactionAndCreatedBridgeXma=a;g.checkMediaChunkAndHandleXmaAfterTransaction=b;g.checkMediaChunkAndCreatedBridgeXma=h;g.checkAllMediaChunksAndHandleXmaAfterTransaction=c;g.checkAllMediaChunksAndCreateBridgeXma=i;g.verifyAllMediaChunksForXMA=j;g.checkAllMediaChunksAndCreateBridgeXma_DEPRECATED=e}),98);
__d("MAWLegacyDownloadManager",[],(function(a,b,c,d,e,f){"use strict";var g=1e4;a=function(){function a(){this.$1=[],this.$2=new Map()}var b=a.prototype;b.setToDownloadManager=function(a,b){this.$3(),this.$2.set(a,b),this.$1.push(a)};b.getFromDownloadManager=function(a){return this.$2.get(a)};b.removeFromMediaDownloadManager=function(a){this.$2["delete"](a);var b=this.$1.filter(function(b){return b!==a});this.setDownloadManagerQueue(b)};b.setDownloadManagerQueue=function(a){this.$1=a};b.$3=function(){if(this.$1.length>=g){var a=this.$1.shift();this.$2["delete"](a)}};return a}();f.LegacyDownloadManager=a}),66);
__d("MAWLegacyMediaDownloadManager",["MAWLegacyDownloadManager"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("MAWLegacyDownloadManager").LegacyDownloadManager)(),i=new(d("MAWLegacyDownloadManager").LegacyDownloadManager)();function a(a,b){h.setToDownloadManager(a,b)}function b(a){return h.getFromDownloadManager(a)}function c(a){h.removeFromMediaDownloadManager(a)}function e(a,b){i.setToDownloadManager(a,b)}function f(a){return i.getFromDownloadManager(a)}function j(a){i.removeFromMediaDownloadManager(a)}g.setToMediaDownloadManager=a;g.getFromMediaDownloadManager=b;g.removeFromMediaDownloadManager=c;g.setToMediaPlaintextDownloadManager=e;g.getFromMediaPlaintextDownloadManager=f;g.removeFromMediaPlaintextDownloadManager=j}),98);
__d("MAWMediaType",["WAServerMediaType"],(function(a,b,c,d,e,f,g){"use strict";function a(a){switch(a){case"XMA":return"xma-image";case"EphemeralScreenshotAction":case"Raven":case"RavenAction":case"EditAction":case"NoteReply":case"BumpExistingMessage":return null;default:return d("WAServerMediaType").getMediaType(a)}}g.getMediaType=a}),98);
__d("MAWRavenUtils",["EphemeralMediaViewMode","MAWMsg","RavenMessagingState"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a){switch(a){case d("MAWMsg").MAWRavenMsgEphemeralMediaState.PERMANENT:return c("RavenMessagingState").PERMANENT;case d("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN:return c("RavenMessagingState").UNSEEN;case d("MAWMsg").MAWRavenMsgEphemeralMediaState.SEEN:return c("RavenMessagingState").SEEN;case d("MAWMsg").MAWRavenMsgEphemeralMediaState.REPLAYED:return c("RavenMessagingState").REPLAYED;case d("MAWMsg").MAWRavenMsgEphemeralMediaState.EXPIRED:return c("RavenMessagingState").EXPIRED}},i=function(a){switch(a){case d("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT:return c("EphemeralMediaViewMode").PERMANENT;case d("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY:return c("EphemeralMediaViewMode").REPLAYABLE;case d("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE:return c("EphemeralMediaViewMode").READ_ONCE}};b=function(a,b){return{ephemeralMediaState:b,ephemeralMediaViewMode:i(a)}};function a(a,b){switch(b){case d("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE:return a===d("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN?c("RavenMessagingState").SEEN:h(a);case d("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY:if(a===d("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN)return c("RavenMessagingState").SEEN;else if(a===d("MAWMsg").MAWRavenMsgEphemeralMediaState.SEEN)return c("RavenMessagingState").REPLAYED;return h(a);case d("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT:return h(a)}}g.getEphemeralMediaState=h;g.getEphemeralMediaViewMode=i;g.deriveRavenSettings=b;g.getNextRavenMessageEphemeralState=a}),98);
__d("MAWMediaAfterTxns",["MAWBridgeTypesCreators","MAWDbMedia","MAWDexieTable","MAWIndexedDb","MAWMediaType","MAWMediaUtils","MAWMpsGating","MAWRavenUtils","MpsMediaEntryCache","MpsToBridgeMessageId","MpsTypes","WAHashUtils","WAMediaUtils","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,i,j){return f.messages.where("msgId").anyOf(b.msgIds).toArray().then(function(k){var l=a.threadJid,m=d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(k,l);k=d("MAWMediaUtils").createHdTypesForBridgeMedia(k);l=a.ravenEphemeralType!=null&&a.ravenEphemeralMediaState!=null?d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:l,filteredMsgIds:m,hasMediaForUI:e,hdTypes:k,media:b,ravenSettings:d("MAWRavenUtils").deriveRavenSettings(a.ravenEphemeralType,a.ravenEphemeralMediaState),sortOrderMs:a.sortOrderMs,transportKey:i}):d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:l,filteredMsgIds:m,hasMediaForUI:e,hdTypes:k,media:b,sortOrderMs:a.sortOrderMs,transportKey:i});if(d("MAWMpsGating").isMpsMessageRendering()&&j===!0){m=c("nullthrows")(b.mediaEntries.get(a.msgId));k=(k=(k=b.validatedImageInfo)==null?void 0:k.thumbnailPlaintextHash)!=null?k:(k=b.validatedVideoInfo)==null?void 0:k.thumbnailPlaintextHash;if(k==null){var n=d("WAMediaUtils").mediaEntryDataToRawData(b.plaintextHash,m);n=n.downloadableThumbnail;(n==null?void 0:n.fileSha256)!=null&&(k=d("WAHashUtils").toPlaintextHash(n.fileSha256))}d("MpsMediaEntryCache").storeEntry({mediaEntry:m,mediaKeyTimestamp:b.ts,msgId:d("MpsToBridgeMessageId").mpsToBridgeMsgId(d("MpsTypes").toThreadId(a.threadJid),d("MpsTypes").toMessageId(a.externalId)),plainTextHash:b.plaintextHash,serverMediaType:c("nullthrows")(d("MAWMediaType").getMediaType(b.mediaType)),thumbnailHash:k})}return h(f,babelHelpers["extends"]({},l,{skipShouldUpdateHasMore:g}),void 0,j)})}function h(a,b,c,e){if(!i(b)){d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:b},e);return d("MAWDexieTable").dexieResolve()}return d("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(a,b,c).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:a},e)})}function i(a){if(a.ephemeralMediaState!=null||a.ephemeralMediaViewMode!=null)return!1;switch(a.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:case d("MAWDbMedia").MEDIA_TYPE.VIDEO:case d("MAWDbMedia").MEDIA_TYPE.GIF:case d("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return!0;default:return!1}}g.handleNewMediaAfterTxn=a;g.handleNewMediaAfterTxnWithBridgeMedia=h}),98);
__d("MAWVideoAudioValidationUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a){return{audioAvgBitsPerSecond:a.audioAvgBitsPerSecond!=null?Math.round(a.audioAvgBitsPerSecond):null,audioNumberOfChannels:a.audioNumberOfChannels!=null?Math.round(a.audioNumberOfChannels):null,audioSamplingRate:a.audioSamplingRate!=null?Math.round(a.audioSamplingRate):null,audioStreamType:a.audioStreamType,validatedMimeType:a.validatedMimeType,videoAvgBitsPerSecond:a.videoAvgBitsPerSecond!=null?Math.round(a.videoAvgBitsPerSecond):null,videoCalculatedFps:a.videoCalculatedFps!=null?Math.round(a.videoCalculatedFps):null,videoDuration:a.videoDuration!=null?Math.round(a.videoDuration):null,videoHeight:a.videoHeight!=null?Math.round(a.videoHeight):null,videoNominalFps:a.videoNominalFps!=null?Math.round(a.videoNominalFps):null,videoStreamType:a.videoStreamType,videoWidth:a.videoWidth!=null?Math.round(a.videoWidth):null}}f.normalizeValidationResult=a}),66);
__d("MAWHandleMediaDownloadApi",["MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLegacyMediaDownloadManager","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWMediaUtils","MAWMsgType","MAWTransactionMode","MAWVideoAudioValidationUtils","MAWXMAUtils","MWFBLogger","Promise","WAArmadilloXMA.pb","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=d("MWFBLogger").MWMediaLogger().tags([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive]);e=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READWRITE,media:a.READWRITE,messages:a.READONLY,receiverFetchInfo:a.READONLY,threads:a.READONLY,xma:a.READONLY},"handleMediaDownload",function(a){return function(e,f,g,o,p){l.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["start persisting media blob"])));var q=d("MAWMediaUtils").genHMACPlaintextHash(e);return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,o),a.media.where("hashedPlaintextHash").equals(q).first(),d("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(a,e,g,f)]).then(function(h){var o=h[0],q=h[1];h[2];if(q==null){l.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Media is null when storing downloaded blob"])));return d("WAResultOrError").makeError("missing-media-on-save")}var r;h=!1;r=d("MAWLegacyMediaDownloadManager").getFromMediaPlaintextDownloadManager(e);r==null&&!c("gkx")("6417")&&(r=d("MAWLegacyMediaDownloadManager").getFromMediaDownloadManager(q.mediaId),h=!0);r!=null&&(l.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["resolve MediaPlaintextDownloadManager promise"]))),r((k||(k=b("Promise"))).resolve(new Blob([g],{type:f}))),d("MAWLegacyMediaDownloadManager").removeFromMediaPlaintextDownloadManager(e),h&&d("MAWLegacyMediaDownloadManager").removeFromMediaDownloadManager(q.mediaId));return m(a,o).then(function(b){if(!b)return a.messages.where("msgId").anyOf(q.msgIds).toArray().then(function(b){return a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(c){return d("MAWDexieTable").dexieAll(c.map(function(c){var e=d("MAWMediaUtils").createHdTypesForBridgeMedia(b);c=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:c.jid,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,c.jid),hasMediaForUI:!0,hdTypes:e,media:q,sortOrderMs:o==null?void 0:o.sortOrderMs});return d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,c,b)}))}).then(function(){return b})}).then(function(b){return n(a,b)});else return a.messages.where("msgId").anyOf(q.msgIds).toArray().then(function(b){return d("MAWDbXMATxns").getXMAFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){if(d("MAWXMAUtils").isXMAStoryReply(b.targetType))return;if(b.defaultPreviewMediaId!==q.mediaId)return;return d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(a,b,q)}))}).then(function(){return b})}).then(function(b){return n(a,b)})}).then(function(){var b,c,e,f,h,i,j,k,l,m,n,o=q.mediaType===d("MAWDbMedia").MEDIA_TYPE.VIDEO?d("MAWVideoAudioValidationUtils").normalizeValidationResult({audioAvgBitsPerSecond:p==null||(b=p.audioStreamReport)==null?void 0:b.avgBitsPerSecond,audioNumberOfChannels:p==null||(c=p.audioStreamReport)==null?void 0:c.numberOfChannels,audioSamplingRate:p==null||(e=p.audioStreamReport)==null?void 0:e.samplingRate,audioStreamType:p==null||(f=p.audioStreamReport)==null?void 0:f.streamType,validatedMimeType:p==null?void 0:p.mimeType,videoAvgBitsPerSecond:p==null||(h=p.videoStreamReport)==null?void 0:h.avgBitsPerSecond,videoCalculatedFps:p==null||(i=p.videoStreamReport)==null?void 0:i.calculatedFps,videoDuration:p==null||(j=p.videoStreamReport)==null?void 0:j.duration,videoHeight:p==null||(k=p.videoStreamReport)==null?void 0:k.videoHeight,videoNominalFps:p==null||(l=p.videoStreamReport)==null?void 0:l.nominalFps,videoStreamType:p==null||(m=p.videoStreamReport)==null?void 0:m.streamType,videoWidth:p==null||(n=p.videoStreamReport)==null?void 0:n.videoWidth}):void 0;o=d("MAWDbMediaTxns").updateMedia(a,q,{size:g.byteLength,validatedResult:o});return o}).then(function(){return d("WAResultOrError").makeResult()})})}});function m(a,b){var c;if(b==null)return d("MAWDexieTable").dexieResolve(!1);if(b.type===d("MAWMsgType").MSG_TYPE.XMA)return d("MAWDexieTable").dexieResolve(!0);return((c=b.quote)==null?void 0:c.content.xmaMessageType)===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY?d("MAWDexieTable").dexieResolve(b.type===d("MAWMsgType").MSG_TYPE.TEXT):d("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(a,b.msgId).then(function(a){return a!=null})}function n(a,b){return d("MAWGetMsgQuoteTxn").maybeBatchGetMsgsByQuoteExternalId(a,b.map(function(a){return a.externalId})).then(function(b){return b.map(function(b){b.source="eb_restore";return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,a)})})})})}g.handleMediaDownload=e}),98);
__d("MAWMediaDownloadStatusForUI",["MAWBridge","MAWLoggerUtils","MAWMediaDownloadStatus","MWFBLogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("MWFBLogger").MWMediaLogger().tags([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive]);function a(a){var b=a.details,c=a.hash,d=a.status,e=a.type;a=a.validationResult;j({details:b,hash:c,status:d,type:e,validationResult:a})}function j(a){var b=a.details,c=a.hash,e=a.status,f=a.type;a=a.validationResult;d("MAWBridge").getBridge().fireAndForget("event","updateMediaStatus",{details:b,key:c,status:e,type:f,validationResult:a})}function b(a){switch(a){case"disconnected":case"backoff":case"body-network-error":case"no-host":case"download-throttled":case"max-attempts-exceeded":case"runtime-error":case"access-expired":case"http-fetch-exception":case"http-fetch-aborted":case"unspecified-http-error":case"server-timeout":return c("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE;case"request-error":case"media-not-found":case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"decryption-error":case"enc-hash-mismatch":case"hash-mismatch":case"ciphertext-hash-mismatch":case"signature-expired":return c("MAWMediaDownloadStatus").NOT_MANUAL_RETRYABLE_FAILURE;default:a;i.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["getStatusTypeFromWAAPIDownloadMediaError: Unknown error type ",""])),String(a));return c("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE}}g.sendMediaDownloadStatusToUI=a;g.getStatusFromWAAPIDownloadMediaError=b}),98);
__d("MAWMediaManagementTxns",["EBLogger","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWMediaAfterTxns","MAWMediaBackupTxns","MAWMediaUtils","MAWMsgType","MAWODSProxy","MAWSupportedDocumentTypes","MAWWriteMsgTxns","MWFBLogger","WAErrorMessage","WAHashUtils","WAMediaUtils","WAOdsEnums","WASortedLists","WATimeUtils","emptyFunction","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q=d("MWFBLogger").MWMediaLogger().tags(["MAWMediaManagementTxns"]),r=c("gkx")("23924");function a(a,b,c,e){var f=c==null||b.type===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE&&(r||!d("MAWSupportedDocumentTypes").isAllowedType((c=c.validatedDocumentFileInfo)==null?void 0:c.filename));return d("MAWWriteMsgTxns").prepareMsgWriteData(a,b,e).then(function(a){return babelHelpers["extends"]({},a,{shouldDropDocument:f})})}function b(a,b,c,e,f){f===void 0&&(f=!1);var g={validatedAudioInfo:b.validatedAudioInfo,validatedDocumentFileInfo:b.validatedDocumentFileInfo,validatedImageInfo:b.validatedImageInfo,validatedVideoInfo:b.validatedVideoInfo},h=d("WAMediaUtils").decodeMediaEntryData(b.mediaEntry);h=h.objectId!=null?d("WAMediaUtils").stringToDeliveryObjectId(h.objectId):null;return t(a,c,e,b.plaintextHash,b.mediaType,b.size,b.mediaEntry,g,h,void 0,f,void 0,b.accessibilitySummaryText)}function e(a,b,c,e,f,g,h){f===void 0&&(f=!1);h===void 0&&(h=!0);var i=d("MAWMediaUtils").genHMACPlaintextHash(b.plaintextHash);b=d("WAMediaUtils").decodeMediaEntryData(b.mediaEntry);b=b.objectId!=null?d("WAMediaUtils").stringToDeliveryObjectId(b.objectId):null;return d("MAWDexieTable").dexieAll([u(a,c,e,b,void 0,f),d("MAWDbChunkTxns").hasMediaChunk(a,i)]).then(function(b){var d=b[0];b=b[1];return v(a,c,d,f,g,h,b)})}function f(a,b,c,e,f,g,h,i){f===void 0&&(f=!1);g===void 0;i===void 0&&(i=!0);e={validatedAudioInfo:b.validatedAudioInfo,validatedDocumentFileInfo:b.validatedDocumentFileInfo,validatedImageInfo:b.validatedImageInfo,validatedVideoInfo:b.validatedVideoInfo};g=d("MAWMediaUtils").genHMACPlaintextHash(b.plaintextHash);var j=d("WAMediaUtils").decodeMediaEntryData(b.mediaEntry);j=j.objectId!=null?d("WAMediaUtils").stringToDeliveryObjectId(j.objectId):null;return d("MAWDexieTable").dexieAll([s(a,c,b.plaintextHash,b.mediaType,b.size,b.mediaEntry,e,j,void 0,f,b.accessibilitySummaryText),d("MAWDbChunkTxns").hasMediaChunk(a,g)]).then(function(b){var d=b[0];b=b[1];return v(a,c,d,f,h,i,b)})}function s(a,b,c,d,e,f,g,h,i,j,k){j===void 0&&(j=!1);return t(a,b.msgId,b.type,c,d,e,f,g,h,i,j,void 0,k).then(function(c){return u(a,b,c,h,void 0,j)})}function t(a,b,c,e,f,g,l,m,n,o,p,r,s){p===void 0&&(p=!1);r===void 0&&(r=0);s===void 0&&(s=null);return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,e).then(function(u){var v=new Map(u==null?void 0:u.mediaEntries),w=A(l,n,o);w!=null&&v.set(b,w);if(u){r>0&&q.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Media found after retry for plaintextHash: ",""])),d("WAHashUtils").sanitisePlaintextHash(e));u.msgIds||q.mustfix("Media missing msgIds: media type=%s",u.mediaType);u.mediaType||q.mustfix("Media missing mediaType: type=%s ; msg type=%s",f,c);var x=babelHelpers["extends"]({},u,m,{accessibilitySummaryText:s!=null?s:void 0,mediaEntries:v,mediaType:(w=u.mediaType)!=null?w:f,msgIds:d("WASortedLists").addToSet(u.msgIds||d("WASortedLists").emptySet(),b)});return a.media.put(x).then(function(){return x})}else{var y=d("MAWMediaUtils").genHMACPlaintextHash(e),z=babelHelpers["extends"]({accessibilitySummaryText:s!=null?s:void 0,fbid:o!=null?o:void 0,hashedPlaintextHash:y,mediaEntries:v,mediaType:f,msgIds:d("WASortedLists").singleElement(b),objectId:n!=null?n:void 0,plaintextHash:e,size:g,ts:d("WATimeUtils").unixTime()},m);return a.media.add(z).then(function(a){return babelHelpers["extends"]({},z,{mediaId:a})})["catch"](function(h){var u=d("WAErrorMessage").maybeGetMessageFromError(h);if(r>0){q.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry: plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""])),d("WAHashUtils").sanitisePlaintextHash(e),y,u);q.catching(h).MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry."])));throw h}else{q.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""])),d("WAHashUtils").sanitisePlaintextHash(e),y,u);d("MAWODSProxy").odsBumpEntityKey({amount:1,entity:d("WAOdsEnums").Entity.MAW_MEDIA_DB_DUPLICATE_MEDIA,key:"retry"});return t(a,b,c,e,f,g,l,m,n,o,p,r+1,s)}})}})}function u(a,b,c,e,f,g){g===void 0&&(g=!1);g=g?d("MAWDexieTable").dexieResolve():d("MAWDbMsgTxns").updateMediaId(a,b,c.mediaId,c.plaintextHash);return g.then(function(){return d("MAWMediaBackupTxns").linkMediaBackup(a,c.mediaId,b.msgId,e,f).then(function(){return c})})}function v(a,b,c,e,f,g,h){e===void 0&&(e=!1);g===void 0&&(g=!0);d("EBLogger").EBLogger().tags(["restore","handleUnstoredDbMedia"]).DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Inserted media with plaintextHash: ",""])),d("WAHashUtils").sanitisePlaintextHash(c.plaintextHash));return b.type!==d("MAWMsgType").MSG_TYPE.REVOKED&&!e&&g?d("MAWMediaAfterTxns").handleNewMediaAfterTxn(b,c,h,a,void 0,f).then(function(){return c}):d("MAWDexieTable").dexieResolve(c)}var w=function(a,b,c,e,f,g,h,i,j,k,l){j===void 0&&(j=!1);return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){if(b==null)throw q.mustfixThrow("Do not have the media message in db when attachHashToMediaMsg");else return s(a,b,c,g,h,l,i,e,f,j,k)})},x=function(a,b,e){return d("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(a,b).then(function(b){if(b!=null){var d=babelHelpers["extends"]({},b);e.validatedAudioInfo!=null&&(d.validatedAudioInfo=babelHelpers["extends"]({},b.validatedAudioInfo,e.validatedAudioInfo));e.validatedVideoInfo!=null&&(d.validatedVideoInfo=babelHelpers["extends"]({},b.validatedVideoInfo,e.validatedVideoInfo));e.validatedImageInfo!=null&&(d.validatedImageInfo=babelHelpers["extends"]({},b.validatedImageInfo,e.validatedImageInfo));e.validatedDocumentFileInfo!=null&&(d.validatedDocumentFileInfo=babelHelpers["extends"]({},b.validatedDocumentFileInfo,e.validatedDocumentFileInfo));return a.media.update(d.mediaId,d).then(c("emptyFunction"))}else q.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing, can't update media info"])))})},y=function(a,b,c,e){return d("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(a,b).then(function(b){if(b!=null){var f=e?b.mediaEntries.set(c,e):b.mediaEntries;b=babelHelpers["extends"]({},b,{mediaEntries:f});return a.media.update(b.mediaId,b)}else{q.MUSTFIX(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][updateMediaWithEncodedMediaEntryData] media entry is missing, can't upate media with encoded data"])));return d("MAWDexieTable").dexieResolve()}})};function z(a,b,c,e,f,g,h,i,j,k,l,m){k===void 0&&(k=!1);return d("MAWDexieTable").dexieAll([w(a,b,e,f,g,h,j.size,i,k,l,m),d("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(a,e,c,j.type)]).then(function(a){a=a[0];return a})}function A(a,b,c){var e;a=a;a!=null&&b!=null&&(e=d("WAMediaUtils").decodeMediaEntryData(a),a=d("WAMediaUtils").encodeMediaEntryWithUpdatedObjectId(e,b));a!=null&&c!=null&&(e=d("WAMediaUtils").decodeMediaEntryData(a),a=d("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(e,c));return a}function B(a,b,c){var e=new Map();a.mediaEntries.forEach(function(a,f){var g=d("WAMediaUtils").decodeMediaEntryData(a);g=g.objectId===b?d("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(g,c):a;e.set(f,g)});return e}function C(a,b,c,e,f){f===void 0&&(f=!0);var g=new Map();b.forEach(function(a){var b;b=(b=g.get(a.hashedPlaintextHash))!=null?b:[];b.push(a);g.set(a.hashedPlaintextHash,b)});return d("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(a,[].concat(Array.from(g.keys()))).then(function(h){var i=new Map(h.map(function(a){return[a.hashedPlaintextHash,a]})),j=new Map();b.forEach(function(a){var b=i.get(a.hashedPlaintextHash);if(a==null)return;var c=A(a==null?void 0:a.entry,a==null?void 0:a.objectId,a==null?void 0:a.fbId);if(b){var e=c?b.mediaEntries.set(a.msgId,c):b.mediaEntries;e=babelHelpers["extends"]({},b,{mediaEntries:e,msgIds:d("WASortedLists").addToSet(b.msgIds,a.msgId)});i.set(a.hashedPlaintextHash,e)}else J(j,a,c)});var k=new Map(),l=new Map();h=Array.from(j.values()).filter(function(a){return D(a,k,l)});return d("MAWDexieTable").dexieAll([a.media.bulkAdd(h),a.media.bulkPut(Array.from(i.values()))]).then(function(){return E(a,[].concat(Array.from(g.keys())),g,c,e,f)})})}function D(a,b,c){if(a.objectId!=null){var d=b.get(a.objectId);if(d!=null&&d!==a.hashedPlaintextHash){q.MUSTFIX(o||(o=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same objectId assigned for different mediaIds. objectId: "," shared by  hashedPlaintextHashes: "," ",""])),a.objectId,d,a.hashedPlaintextHash);return!1}}if(a.fbid!=null){d=c.get(a.fbid);if(d!=null&&d!==a.hashedPlaintextHash){q.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same FBId assigned for different mediaIds. fbId: "," - shared by hashedPlaintextHashes: "," ",""])),a.fbid,d,a.hashedPlaintextHash);return!1}}a.objectId!=null&&b.set(a.objectId,a.hashedPlaintextHash);a.fbid!=null&&c.set(a.fbid,a.hashedPlaintextHash);return!0}function E(a,b,c,e,f,g){return d("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(a,b).then(function(b){return d("MAWDexieTable").dexieAll([H(a,b,c)]).then(function(){g&&F(b,c,e,a,f);return b})})}function F(a,b,e,f,g){a.forEach(function(a){var h=b.get(a.hashedPlaintextHash);h!=null&&!G(h)&&c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(f.messages.where("msgId").anyOf(a.msgIds).toArray().then(function(b){var c=d("MAWMediaUtils").createHdTypesForBridgeMedia(b);b=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:e,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,e),hasMediaForUI:!1,hdTypes:c,media:a,transportKey:g});return d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(f,b)})))})}function G(a){return a.reduce(function(a,b){return a||b.isXMAShare},!1)}function H(a,b,c){b=b.reduce(function(a,b){var d;(d=c.get(b.hashedPlaintextHash))==null||d.filter(function(a){return a!=null&&!a.isXMAShare}).forEach(function(c){return a.set(c.msgId,b.mediaId)});return a},new Map());return d("MAWDbMsgTxns").bulkUpdateMediaId(a,b)}function I(a,b){var c;a=a?new Map([[b.msgId,a]]):new Map();return babelHelpers["extends"]({fbid:(c=b.fbId)!=null?c:void 0,hashedPlaintextHash:b.hashedPlaintextHash,mediaEntries:a,mediaType:b.mediaType,msgIds:d("WASortedLists").singleElement(b.msgId),objectId:(c=b.objectId)!=null?c:void 0,plaintextHash:b.plaintextHash,size:b.size,ts:d("WATimeUtils").unixTime()},b.mediaInfo)}function J(a,b,c){var d=a.get(b.hashedPlaintextHash);d==null?a.set(b.hashedPlaintextHash,I(c,b)):(c!=null&&d.mediaEntries.set(b.msgId,c),d.msgIds.push(b.msgId))}g.prepareMediaWriteData=a;g.handleUnstoredDbMediaCreation=b;g.handleUnstoredDbMediaLinking=e;g.handleUnstoredDbMedia=f;g.linkMedia=s;g.createOrUpdateMediaRow=t;g.attachHashToMediaMsg=w;g.updateMediaEntryWithValidatedMediaInfo=x;g.updateMediaWithEncodedMediaEntryData=y;g.attachHashAndSaveMedia=z;g.updateBackupFbidInMediaEntries=B;g.bulkLinkMedia=C;g.linkMessageAndMediaBackupForMediaList=E}),98);
__d("MAWMediaRetryInfo",[],(function(a,b,c,d,e,f){"use strict";var g=new Map();function a(a,b){g.set(a,b)}function b(a){return g.get(a)}function c(a){g.has(a)&&g["delete"](a)}f.setRetriedMediaInfo=a;f.getRetriedMediaInfo=b;f.clearRetriedMediaInfo=c}),66);
__d("WAAPI",["cr:21048"],(function(a,b,c,d,e,f,g){"use strict";g["default"]=b("cr:21048")}),98);
__d("MAWHandleEchoMediaMsgsRestoreV2",["EBLogger","EchoMessage","EchoMessageMediaFieldUtils","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTypesCreators","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWEncodeMediaTransportProtocol","MAWFrontendMediaUtils","MAWGetMsgForProtocolMsgIdTxn","MAWHandleMediaDownloadApi","MAWIndexedDb","MAWJids","MAWJobDefinitions","MAWJobManager","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaManagementTxns","MAWMediaRetryInfo","MAWMediaUtils","MAWSupportedDocumentTypes","MAWTransactionMode","WAAPI","WAArmadilloXMA.pb","WABase64","WAGetAgeBucketForMediaKeyTimestamp","WAGetStorageQplAnnotations","WAHashUtils","WAIsMediaExpiredError","WAJids","WAJobOrchestratorTypes","WAMediaUtils","WAStartMediaDownloadQplFlow","WATimeUtils","cr:10071","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P=d("EBLogger").EBLogger().tags(["restore"]);function Q(a){var b=T(a);return b.then(function(b){var c=new Map();a.forEach(function(a){var d=b.get(a);d=d==null?void 0:d.blobData;c.set(a,d)});return Promise.resolve(c)})}function R(a){switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG:return"image/jpeg";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_PNG:return"image/png";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER:return"image/webp";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF:return"image/gif";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4:return"audio/mp4";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV:return"audio/wav";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.XMA:return"xma"}}async function a(a,b,e){if(a.length===0)return Promise.resolve();var f=[],g=[],v=new Map(),w=new Map();a.map(function(a){var b=a.mediaData,c=a.messageTimestamp,e=U(b.plaintextHash),r=b.attachmentObjectId,s=b.attachmentType,t=b.backupEntFbid,u=b.directPath,x=b.filename,y=b.height,z=b.mediaContentType,A=b.mediaKeyTimestamp,B=b.mediaPlayableDuration,C=b.previewContentHeight,D=b.previewContentType,E=b.previewContentWidth,F=b.size;b=b.width;var G=d("WAHashUtils").stringToPlaintextHash(e),H=d("MAWMediaUtils").genHMACPlaintextHash(G);g.push(H);z=z!=null?d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(z,a.isXMA):D!=null?d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(R(D)):null;if(z==null){P.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - media content type null, msg id: ",""])),a.externalId);P.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - media content type null"])));return Promise.resolve()}if(s===d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT&&!d("MAWSupportedDocumentTypes").isAllowedType(x)){P.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - document extension is disallowed, msg id: ",""])),a.externalId);return Promise.resolve()}D=a.mediaData.encryptedHash;if(D==null){P.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash cannot be null, msg id: ",""])),a.externalId);P.MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash cannot be null"])));return Promise.resolve()}s=a.mediaData.mediaKey;if(s==null){P.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Media key cannot be null, msg id: ",""])),a.externalId);P.MUSTFIX(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Media key cannot be null"])));return Promise.resolve()}var I=z.mediaType;z=z.serverMediaType;r=d("WAMediaUtils").stringToDeliveryObjectId(r);t=t!=null?d("WAMediaUtils").stringToBackupEntFbid(t):void 0;var J=a.threadJId,K=V({filename:x,height:y,mediaPlayableDuration:B,mediaType:I,previewContentHeight:C,previewContentWidth:E,width:b});w.set(r,{filename:x,height:y,mediaPlayableDuration:B,mediaType:I,messageTimestamp:c,plaintextHash:G,previewContentHeight:C,previewContentWidth:E,serverMediaType:z,threadJId:J,width:b});y=null;if(a.previewMediaData!=null)try{y=X(a.previewMediaData),y!=null&&y.objectId==null&&P.MUSTFIX(o||(o=babelHelpers.taggedTemplateLiteralLoose(["downloadableThumbnail was created without metadata, source: echo"])))}catch(b){P.catching(b).DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Unable to construct downloadableThumbnail from previewMediaData, msg id: ",""])),a.externalId),P.catching(b).MUSTFIX(q||(q=babelHelpers.taggedTemplateLiteralLoose(["Unable to construct downloadableThumbnail from previewMediaData"])))}if(D!=null){B=W(e,D,s,u,A,z,x,t,r,y,F);f.push({entry:B,fbId:t,hashedPlaintextHash:H,isXMAShare:a.isXMA,mediaInfo:K,mediaType:I,msgId:a.msgId,objectId:r,plaintextHash:G,size:F!=null?F:0})}C=(c=v.get(H))!=null?c:[];C.push(a);v.set(H,C)});a=e!==c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE;var x=await S(f,b,a);a=await Q(g);var y=[];a.forEach(function(a,g){var h=v.get(g);h==null||h.forEach(function(h){if(h==null)return;if(a!=null){P.DEBUG(r||(r=babelHelpers.taggedTemplateLiteralLoose(["media for message: "," is already downloaded on the device"])),h.externalId);var i=x.find(function(a){return a.plaintextHash===h.mediaData.plaintextHash});if(i==null){P.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message with mediaKey ",""])),h.mediaData.mediaKey);return}return aa(i.msgIds).then(function(a){a=a.filter(function(a){return d("MAWDbMsg").isMediaMsg(a)});if(a.length>0){var c=d("MAWMediaUtils").createHdTypesForBridgeMedia(a);c=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:h.threadJId,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(a,b),hasMediaForUI:!0,hdTypes:c,media:i,transportKey:"EncryptedBackups"});c=d("MAWMediaUtils").annotateBridgeMediaForDisplay(c,a);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMedia",value:c}]})}})}var j=w.get(d("WAMediaUtils").stringToDeliveryObjectId(h.mediaData.attachmentObjectId));if(h==null||j==null)return;var k=j.filename,l=j.height,m=j.mediaPlayableDuration,n=j.mediaType,o=j.messageTimestamp,p=j.plaintextHash,q=j.previewContentHeight,v=j.previewContentWidth,z=j.serverMediaType,A=j.threadJId;j=j.width;var B=d("WAJids").extractUserId(d("MAWJids").toUserJid(h.threadJId));z=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(z,h.isXMA);if(z!=null){z={attachmentObjectId:d("WAMediaUtils").stringToDeliveryObjectId(h.mediaData.attachmentObjectId),mediaType:z,messageId:h.externalId,messageTimeStamp:h.messageTimestamp,msgId:h.msgId,plaintextHash:p,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,threadId:B,threadJid:A};B=f.find(function(a){return a.hashedPlaintextHash===g});B=B==null?void 0:B.entry;if(B==null){P.DEBUG(t||(t=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message, plaintextHash: ",", msg id: ",""])),d("WAHashUtils").sanitisePlaintextHash(d("WAHashUtils").stringToPlaintextHash(h.mediaData.plaintextHash)),h.externalId);P.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message"])));return}if(e===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE)return;var C=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:{author:h.author,chat:h.threadJId,externalId:h.externalId},triggerUIView:null});y.push(Y({author:h.author,directPath:h.mediaData.directPath,echoMsg:h.echoMsg,externalId:h.externalId,filename:k,hashedPlaintextHash:g,height:l,isXMA:h.isXMA,mediaPlayableDuration:m,mediaType:n,messageTimestamp:o,plaintextHash:p,previewContentHeight:q,previewContentWidth:v,threadJId:A,width:j},void 0,z,void 0,d("WAMediaUtils").decodeMediaEntryData(B),C))}})});await Promise.all(y)}var S=(e=d("MAWIndexedDb")).makeMsgrTransactor({media:(f=d("MAWTransactionMode")).READWRITE,mediaBackup:f.READWRITE,messages:f.READWRITE},"restoreLinkMedias",function(a){return function(b,c,e){return d("MAWMediaManagementTxns").bulkLinkMedia(a,b,c,"EncryptedBackups",e)}}),T=e.makeMsgrTransactor({chunk:f.READONLY},"getChunksByHash",function(a){return function(b){return d("MAWDbChunkTxns").maybeBulkGetChunksFromHash(a,b)}}),aa=e.makeMsgrTransactor({messages:f.READONLY},"getMessagesForMsgIds",function(a){return function(b){return a.messages.where("msgId").anyOf(b).toArray()}});function U(a){if(a.endsWith("=")){var b="";for(var c=0;c<a.length;c++){var d=a.charAt(c);if(d==="=")return b;b+=d}}return a}function V(a){var b=a.height,c=a.mediaType,e=a.width,f=a.previewContentHeight,g=a.previewContentWidth,h=a.mediaPlayableDuration;a=a.filename;return{validatedAudioInfo:c==="Ptt"&&h!=null?{duration:ca(h),mimetype:d("MAWEncodeMediaTransportProtocol").AUDIO_WAV_MIME_TYPE,played:!1}:null,validatedDocumentFileInfo:c==="DocumentFile"?{filename:a,mimetype:d("MAWEncodeMediaTransportProtocol").FILE_MIME_TYPE}:null,validatedImageInfo:c==="Image"?{height:b,jpegThumbnailHeight:f,jpegThumbnailWidth:g,width:e}:c==="Gif"||c==="Sticker"?{height:b,jpegThumbnailHeight:b,jpegThumbnailWidth:e,width:e}:null,validatedVideoInfo:c==="Video"?{duration:h,height:b,jpegThumbnailHeight:f,jpegThumbnailWidth:g,mimetype:d("MAWEncodeMediaTransportProtocol").VIDEO_MIME_TYPE,width:e}:null}}function W(a,b,c,e,f,g,h,i,j,k,l){a=d("WABase64").decodeB64UrlSafe(a,!0);b=d("WABase64").decodeB64UrlSafe(b,!0);c=d("WABase64").decodeB64UrlSafe(c,!0);return d("WAMediaUtils").rawDataToMediaEntry({directPath:e,downloadableThumbnail:k!=null?k:void 0,fbid:i!=null?i:void 0,fileEncSha256:b,filename:h,fileSha256:a,mediaKey:c,mediaKeyTimestamp:f!=null?d("WATimeUtils").castToUnixTime(f):void 0,objectId:j!=null?j:void 0,serverMediaType:g,size:l!=null?l:void 0})}function X(a){var b=a.attachmentObjectId,c=a.directPath,e=a.encryptedHash,f=a.mediaKey,g=a.mediaKeyTimestamp;a=a.plaintextHash;if(e==null){P.MUSTFIX(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash is null - unable to download thumbnail"])));return}else{g=g!=null?d("WATimeUtils").castToUnixTime(g):void 0;f=f!=null?d("WAMediaUtils").castToMediaKey(d("WABase64").decodeB64UrlSafe(f,!0)):void 0;a=d("WABase64").decodeB64UrlSafe(a,!0);e=d("WABase64").decodeB64UrlSafe(e,!0);return{directPath:c,fileEncSha256:e,fileSha256:a,mediaKey:f,mediaKeyTimestamp:g,objectId:b}}}var Y=async function(a,b,e,f,g,h){var i;P.DEBUG(w||(w=babelHelpers.taggedTemplateLiteralLoose(["start media download from whatsapp infra. traceId: ",""])),b);var j=a.author,k=a.externalId,l=a.filename,m=a.hashedPlaintextHash,n=a.height,o=a.mediaPlayableDuration,p=a.mediaType,q=a.messageTimestamp,r=a.plaintextHash,s=a.previewContentHeight,t=a.previewContentWidth,u=a.threadJId,v=a.width;j={author:j,chat:u,externalId:k};var E=h!=null?h:d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:j,triggerUIView:null});d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore",hash:r,status:c("MAWMediaDownloadStatus").DOWNLOADING,type:"main"});h=((h=(u=d("MAWMediaRetryInfo").getRetriedMediaInfo(k))==null?void 0:u.isXMA)!=null?h:!1)||((u=a==null?void 0:a.isXMA)!=null?u:!1);u=((u=d("MAWMediaRetryInfo").getRetriedMediaInfo(k))==null||(u=u.echoMsg)==null?void 0:u.serializationOrigin)||(a==null||(i=a.echoMsg)==null?void 0:i.serializationOrigin)||d("EchoMessage").EchoSerializationOriginType.UNKNOWN;var F=c("gkx")("23960");E.addPoint("download_media_start",{bool:{isEBDownloadEnforced:e==null&&F,isRetryFromMI:e==null,isXMA:h,pathMismatch:f!==g.directPath},int:{mediaEntrySize:g.size},string:{oldDirectPath:(h=a==null?void 0:a.oldDirectPath)!=null?h:"",origin:u,restorationCdnUrl:f!=null?f:""}});void d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){E.addAnnotations(a)});if(e!=null&&F){P.DEBUG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["downloading media from MI directly. externalId ","."])),j.externalId);return $({decodedMediaEntry:g,isEBDownloadEnforced:F,mediaDownloadRequest:a,protocolMsgId:j,retryPayload:e})}h=d("WAMediaUtils").validateDecodedMediaEntryForDownload(g);if(!h.success){P.DEBUG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["media entry validation failed. externalId ",". traceId: ",". error: ","."])),j.externalId,b,h.error);P.MUSTFIX(z||(z=babelHelpers.taggedTemplateLiteralLoose(["media entry validation failed. error: ","."])),h.error);E.endFail("download_media_fail",{string:{failReason:h.error}});return}u=await c("WAAPI").cachedDownloadFullMediaOnly({downloadMediaMetric:E,hash:r,mediaEntry:h.value});if(u.success){E.addPoint("download_media_end");F=u.value;h=F.mimeType;F=F.plaintext;await d("MAWHandleMediaDownloadApi").handleMediaDownload(r,h,F,j);d("MAWMediaRetryInfo").clearRetriedMediaInfo(k);h=V({filename:l,height:n,mediaPlayableDuration:o,mediaType:p,previewContentHeight:s,previewContentWidth:t,width:v});await ba(m,h);P.DEBUG(A||(A=babelHelpers.taggedTemplateLiteralLoose(["media download complete. externalId ",". traceId: ",""])),j.externalId,b);E.endSuccess();d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore_success",hash:r,status:c("MAWMediaDownloadStatus").SUCCESS,type:"main"})}else{F=u.error;if(d("WAIsMediaExpiredError").isMediaExpiredError(F)&&e)E.addPoint("eb_resign_requested"),E.endSuccess(),P.WARN(B||(B=babelHelpers.taggedTemplateLiteralLoose(["Retry download media as signature has expired and should be renewed. externalId ",". traceId: ",""])),j.externalId,b),await $({decodedMediaEntry:g,isEBDownloadEnforced:!1,mediaDownloadRequest:a,protocolMsgId:j,retryPayload:e});else{P.DEBUG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: "," "," when downloading. Message timestamp: ",". traceId: ",""])),k,F,q,b);P.MUSTFIX(D||(D=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: ",""])),F);l={string:{directPath:g.directPath,error:"media_download_failure",restorationCdnUrl:f!=null?f:""}};E.endFail(F,l);d("MAWMediaRetryInfo").clearRetriedMediaInfo(k);d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:F,hash:r,status:d("MAWMediaDownloadStatusForUI").getStatusFromWAAPIDownloadMediaError(F),type:"main"})}}},Z=e.makeMsgrTransactor({media:f.READONLY,mediaBackup:f.READONLY,messages:f.READONLY},"invokeRestoreAccessCheckSprocToDownloadAttachment",function(a){return function(b,c,e){return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,c.plaintextHash).then(function(f){if(f){P.DEBUG(E||(E=babelHelpers.taggedTemplateLiteralLoose(["start resign cdn url through sproc"])));var g=ea(f,c.attachmentObjectId);return d("MAWDbMsgTxns").getMsgsByMsgIds(a,g).then(function(a){var g,h=a.find(function(a){return a.externalId===b});e.addPoint("resign_cdn_url_bridge_call",{bool:{isForwarded:(g=h==null?void 0:h.isForwarded)!=null?g:!1},int:{duplicateMsgsCount:a.length,msgXMAType:h==null?void 0:h.xmaMessageType,totalMediaEntries:f.mediaEntries.size},int_array:{duplicateXMATypes:a.map(function(a){return(a=a.xmaMessageType)!=null?a:0})},string:{msgType:h==null?void 0:h.type},string_array:{duplicateMsgs:a.map(function(a){return a.externalId}),duplicateMsgTypes:a.map(function(a){return a.type})}});d("MAWIndexedDb").afterTransaction({tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:c.attachmentObjectId,mediaType:c.mediaType,messageId:b,msgId:c.msgId,plaintextHash:c.plaintextHash,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:c.messageTimeStamp,threadId:c.threadId,threadJid:c.threadJid,traceId:e.getFlowDetails().instanceKey}})})}else P.DEBUG(F||(F=babelHelpers.taggedTemplateLiteralLoose(["media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ",". traceId: ",""])),b,e.getFlowDetails().instanceKey),P.MUSTFIX(G||(G=babelHelpers.taggedTemplateLiteralLoose(["media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ","."])),b),e.endFail("missing-media")})}}),ba=e.makeMsgrTransactor({media:f.READWRITE,messages:f.READWRITE},"updateMediaWithDownloadedChunkBlob",function(a){return function(b,c){return d("MAWMediaManagementTxns").updateMediaEntryWithValidatedMediaInfo(a,b,c)}});function ca(a){var b=Math.floor(a/1e3);if(b>0)return b;else return a}function da(a){return a==null?!1:a===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY||a===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION}async function $(a){var c=a.decodedMediaEntry,e=a.isEBDownloadEnforced,f=a.mediaDownloadRequest,g=a.protocolMsgId,h=a.retryPayload;a=await d("MAWGetMsgForProtocolMsgIdTxn").getMsgForProtocolMsgIdTxn(g);if(a.success===!0&&da(a.value.xmaMessageType)){P.DEBUG(H||(H=babelHelpers.taggedTemplateLiteralLoose(["Skipping media restore for expirable XMA. externalId ",". xmamessageType: ",""])),g.externalId,a.value.xmaMessageType);return Promise.resolve()}var i=g.externalId;d("MAWMediaRetryInfo").setRetriedMediaInfo(g.externalId,f);f=((a=c.mediaKeyTimestamp)!=null?a:0)>1725105600;a={bool:{is_after_S441705_fix:f,isEBDownloadEnforced:e},int:{mediaKeyTimestamp:c.mediaKeyTimestamp},string:{externalId:i,mediaKeyAge:d("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(c.mediaKeyTimestamp),mediaType:h.mediaType,objectId:h.attachmentObjectId,restoreEntry:"EB",restoreMethod:b("cr:10071")==null?"sproc":"gql"}};var j=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:g,triggerUIView:null});j.addAnnotations(a);P.DEBUG(I||(I=babelHelpers.taggedTemplateLiteralLoose(["start restore media from backup. hash: ",". msgId: ",". traceId: ",""])),d("WAHashUtils").sanitisePlaintextHash(h.plaintextHash),i,j.getFlowDetails().instanceKey);f=c.mediaKey;if(f==null){P.WARN(J||(J=babelHelpers.taggedTemplateLiteralLoose(["media key is missing from media entry. hash: ",". msgId: ",". traceId: ",""])),d("WAHashUtils").sanitisePlaintextHash(h.plaintextHash),i,j.getFlowDetails().instanceKey);j.endFail("missing-media-key");return}if(b("cr:10071")!=null){P.DEBUG(K||(K=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [gql]. hash: ",". msgId: ",". traceId: ",""])),d("WAHashUtils").sanitisePlaintextHash(h.plaintextHash),i,j.getFlowDetails().instanceKey);return b("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:g.chat,deliveryObjectId:h.attachmentObjectId,externalId:i,mediaKey:f,mediaType:h.mediaType,sortOrderMs:h.messageTimeStamp}).then(function(a){if(a.success===!1){P.DEBUG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql failed: ",". hash: ",". externalId ",""])),a.error,d("WAHashUtils").sanitisePlaintextHash(h.plaintextHash),i);j.endFail(a.error);return}P.DEBUG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql success. hash: ",". externalId ",""])),d("WAHashUtils").sanitisePlaintextHash(h.plaintextHash),i);a=d("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",{deliveryObjectId:h.attachmentObjectId,msgId:h.msgId,plaintextHash:h.plaintextHash,restorationCdnUrl:a.value,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW},traceId:j.getFlowDetails().instanceKey});return d("MAWJobManager").getJobManager().fireAndForget(a)}).catch(function(a){P.catching(a).MUSTFIX(N||(N=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql error"]))),j.endFail("runtime-error",{string:{restoreError:a.toString()}})})}P.DEBUG(O||(O=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [sproc]. hash: ",". msgId: ",". traceId: ",""])),d("WAHashUtils").sanitisePlaintextHash(h.plaintextHash),i,j.getFlowDetails().instanceKey);return Z(i,h,j)}function ea(a,b){var c=[];(a=a.mediaEntries)==null||a.forEach(function(a,e){a=d("WAMediaUtils").decodeMediaEntryData(a);a.objectId===b&&c.push(e)});return c}g.downloadMediaAndWriteToMediaStore=a;g.getBase64WithoutPadding=U;g.getMediaInfo=V;g.constructMediaEntry=W;g.constructRawDownloadableThumbnail=X;g.handleDownloadMedia=Y;g.invokeRestoreAccessCheckSprocToDownloadAttachment=Z}),98);
__d("MAWHandleEchoMsgsRestoreApiUtils",["$InternalEnum","EBLogger","EchoMessage","EchoMessageMediaFieldUtils","MAWAckLevel","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWEBRestoreTrackingUtils","MAWJids","MAWMsgType","MAWRepliesRestoreUtils","WAJids","WAResultOrError","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p=d("EBLogger").EBLogger().tags(["restore"]);c=b("$InternalEnum")({INITIAL_RESTORE:"initial_restore",POINT_RESTORE:"point_restore",PAGINATED_RESTORE:"paginated_restore"});function q(a,b){b=b==null?p:p.tags([b]);var c=a.contentType;switch(c){case d("EchoMessage").EchoMessageContentType.TEXT:return a.xContentType===d("EchoMessage").EchoXMessageContentType.BUMP?d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE):d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.TEXT);case d("EchoMessage").EchoMessageContentType.MEDIA:return a.receiverFetchId!=null&&a.receiverFetchData!=null?d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH):a.mediaData==null?d("WAResultOrError").makeError("media_mandatory_fields_missing"):d("WAResultOrError").makeResult(r(a.mediaData));case d("EchoMessage").EchoMessageContentType.PLACEHOLDER:if(a.contentSubtype===d("EchoMessage").EchoMessageContentSubtype.UNSEND)return d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.REVOKED);b.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",", xContentType: ",",\n      subcontent type: "," ,\n      origin: ",""])),d("EchoMessage").EchoMessageContentType.getName(c),a.xContentType!=null?d("EchoMessage").EchoXMessageContentType.getName(a.xContentType):"unknown",d("EchoMessage").EchoMessageContentSubtype.getName(a.contentSubtype),a.serializationOrigin!=null?d("EchoMessage").EchoSerializationOriginType.getName(a.serializationOrigin):"unknown");return d("WAResultOrError").makeError("unsupported_message_type");case d("EchoMessage").EchoMessageContentType.XMA:return d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.XMA);case d("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE:return d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.CIPHERTEXT);default:b.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",""])),d("EchoMessage").EchoMessageContentType.getName(c));return d("WAResultOrError").makeError("unsupported_message_type")}}function r(a){switch(a.attachmentType){case d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE:return d("MAWMsgType").MSG_TYPE.IMAGE;case d("EchoMessageMediaFieldUtils").AttachmentType.STICKER:return d("MAWMsgType").MSG_TYPE.STICKER;case d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO:return d("MAWMsgType").MSG_TYPE.VIDEO;case d("EchoMessageMediaFieldUtils").AttachmentType.GIF:return d("MAWMsgType").MSG_TYPE.GIF;case d("EchoMessageMediaFieldUtils").AttachmentType.PTT:return d("MAWMsgType").MSG_TYPE.PTT;case d("EchoMessageMediaFieldUtils").AttachmentType.XMA:return d("MAWMsgType").MSG_TYPE.XMA;case d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT:return d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}}function a(a,b,c,e,f,g){var h,i=a.from;if(i==null){p.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Author info is missing from msg: ",""])),e);return d("WAResultOrError").makeError("author_missing")}var l=q(a,f);if(l.success===!1)return d("WAResultOrError").makeError(l.error);if(l==null)return d("WAResultOrError").makeError("unsupported_message_type");l=l.value;if((h=a.isTombstoned)!=null?h:!1)return d("WAResultOrError").makeError("message_tombstoned");switch(l){case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.REVOKED:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:return y(a,b,c,i,l,e,f,g);case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return s(a,b,c,i,l,e);case d("MAWMsgType").MSG_TYPE.XMA:return u(a,b,c,i,l,e);case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return d("WAResultOrError").makeResult(B(a,b,c,i,l,e));case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return v(a,b,c,i,l,e);default:p.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Encountered unsupported media type: ",""])),l);return d("WAResultOrError").makeError("unsupported_message_type")}}function s(a,b,c,d,e,f){a=z(a,b,c,d,e,f);return t(e,a)}function t(a,b){switch(a){case d("MAWMsgType").MSG_TYPE.IMAGE:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.IMAGE}));case d("MAWMsgType").MSG_TYPE.STICKER:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.STICKER}));case d("MAWMsgType").MSG_TYPE.VIDEO:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.VIDEO}));case d("MAWMsgType").MSG_TYPE.GIF:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.GIF}));case d("MAWMsgType").MSG_TYPE.PTT:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.PTT}));case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}));default:p.MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Unsupported media message type: ",""])),a);return d("WAResultOrError").makeError("unsupported_media_type")}}function u(a,b,c,e,f,g){var h;if(((h=a.xmaData)==null?void 0:h.xmaTargetType)==null){p.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Mandatory XMA Data missing for XMA message: ",""])),g);return d("WAResultOrError").makeError("xma_mandatory_fields_missing")}h=a.xmaData.xmaTargetType;b=z(a,b,c,e,f,g);c=babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(h)});e=a.text;e!=null&&(c.msgContent={content:e});return d("WAResultOrError").makeResult(c)}function v(a,b,c,e,f,g){if(a.receiverFetchData==null){p.MUSTFIX(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Mandatory receiver fetch data missing for receiver fetch message: ",""])),g);return d("WAResultOrError").makeError("receiver_fetch_mandatory_fields_missing")}b=z(a,b,c,e,f,g);return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{receiverFetchId:a.receiverFetchId,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}))}function w(a){if(a==null)return void 0;else switch(a){case d("EchoMessage").MessageTextSize.SMALL:return 1;case d("EchoMessage").MessageTextSize.MEDIUM:return 2;case d("EchoMessage").MessageTextSize.LARGE:return 3;default:return void 0}}function x(a){if(a.text==null)return null;return a.editHistory.length===0?a.text:a.editHistory.sort(function(a,b){return a.timestamp-b.timestamp})[0].text}function y(a,b,c,e,f,g,h,i){var j=h==null?p:p.tags([h]);i=i==="first_edit_content"?x(a):a.text;if(i==null){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotationsWorker({annotations:{string:{empty_content_msg_type:f}},pointName:"unstored_text_message_empty",traceId:h});j.MUSTFIX(o||(o=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message content is empty for the message: ",", type: ",""])),g,f);return d("WAResultOrError").makeError("text_message_content_empty")}j=z(a,b,c,e,f,g,h);if(f===d("MAWMsgType").MSG_TYPE.REVOKED){i!=null&&(j.msgContent={content:i});a.revokeSentTimestampMs!=null&&(j.originalTs=d("WATimeUtils").castToUnixTime(a.revokeSentTimestampMs));return d("WAResultOrError").makeResult(babelHelpers["extends"]({},j,{revokedExternalId:d("WAStanzaUtils").toStanzaId("0"),type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:a.revokeUnsentTimestampMS!=null?d("WATimeUtils").castToUnixTime(a.revokeUnsentTimestampMS):j.ts}))}if(f===d("MAWMsgType").MSG_TYPE.CIPHERTEXT)return d("WAResultOrError").makeResult(babelHelpers["extends"]({},j,{msgContent:{content:i},specialTextSize:w(a.textSize),type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT}));b=babelHelpers["extends"]({},j,{msgContent:{content:i},specialTextSize:w(a.textSize),type:d("MAWMsgType").MSG_TYPE.TEXT});return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{editCount:Math.max(a.editHistory.length-1,0),groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize}))}function z(a,b,c,e,f,g,h){h=A(e,c);e={ack:h===d("WAJids").AUTHOR_ME?d("MAWAckLevel").ACK.sent:d("MAWAckLevel").ACK.received,altIndex:void 0,author:h,externalId:g,groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize,isForwarded:a.isForwarded,sortOrderMs:a.sortOrderMs,threadJid:b,ts:d("WATimeUtils").castToUnixTime(a.displayTimestampMs/1e3),type:f};a.authoritativeTimestampMs!=null?e.serverTs=d("WATimeUtils").castToUnixTime(a.authoritativeTimestampMs/1e3):e.serverTs=d("WATimeUtils").castToUnixTime(a.sortOrderMs/1e3);if(a.quoteData!=null){h=d("MAWRepliesRestoreUtils").getQuoteDataFromEchoMessage(a,c);h!=null&&(e.quote=h,e.quoteExternalId=h.content.externalId)}return e}function A(a,b){a=d("MAWJids").toUserJid(a.localKey);return a===b?d("WAJids").AUTHOR_ME:a}function B(a,b,c,e,f,g){a=z(a,b,c,e,f,g);return babelHelpers["extends"]({},a,{type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}g.MAWRestoreType=c;g.getDbMsgTypeFromEchoMessage=q;g.getUnstoredDbMessageFromEchoMessage=a;g.resolveAuthorFromEchoAddress=A}),98);
__d("MAWRepliesRestoreUtils",["FBLogger","MAWBridgeMsg","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWTransactionMode","MAWUpdateQuotedMsgTxns","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h=["msgId","originalTs","rowId","threadJid","unsendMsgContentDeleteTs"],i;function a(a,b){if(b==null||!d("MAWMsgType").isQuotedMsgType(b.type))return a;else{b={author:b.author,externalId:b.externalId,ts:b.ts,type:b.type};b={content:b,remoteJid:null};return babelHelpers["extends"]({},a,{quote:b})}}function b(a,b){if(a.quoteData!=null&&a.quoteData.quoteMessageId!=null&&a.quoteData.quoteMessageSender!=null){b={author:d("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(a.quoteData.quoteMessageSender,b),externalId:(b=a.quoteData)==null?void 0:b.quoteMessageId,ts:a.displayTimestampMs,type:d("MAWMsgType").MSG_TYPE.TEXT};return{content:b,remoteJid:null}}else d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Quote data is missing for message: ",""])),a.messageId);return null}f=d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READONLY,media:e.READONLY,messages:e.READWRITE,threads:e.READWRITE,xma:e.READONLY},"updateQuoteDataForReplyMessages",function(a){return function(b,c,e){c==null||c.addPoint("replies_restore_start");b=b.restoredMsgsData;if(b){var f=b.existingMsgs;b=b.newlyAddedMsgs;b=b.concat(f);return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,b.threadJid,b).then(function(a){var c=[];b.quoteExternalId!=null&&c.push(b);a!=null&&c.push.apply(c,a);return c})})).then(function(b){b=b.flat();return j(a,b,e)}).then(function(a){c==null||c.addPoint("replies_restore_end",{"int":{replies:a}});return a})}return d("MAWDexieTable").dexieResolve(0)}});function j(a,b,e){return d("MAWDexieTable").dexieAll(b.map(function(b){var e=k(b);if(b.threadJid!=null)return d("MAWGetMsgQuoteTxn").enhanceMsgWithQuoteInfo(a,e,b.threadJid).then(function(a){return babelHelpers["extends"]({},a,{msgId:b.msgId,originalTs:b.originalTs,protocolMsgId:b.protocolMsgId,rowId:b.rowId,threadJid:b.threadJid,unsendMsgContentDeleteTs:b.unsendMsgContentDeleteTs})});else c("FBLogger")("labyrinth_web","thread_id_absent").mustfix("Reply restore: threadId cannot be null for a restored msg")})).then(function(a){return a.filter(Boolean).filter(function(a){return a.quote!=null})}).then(function(a){return a.map(function(a){a.source="eb_restore";return a})}).then(function(b){return a.messages.bulkPut(b).then(function(c){return b.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){if(e===!0)return;d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,a)})})})}).then(function(a){return(a=b==null?void 0:b.length)!=null?a:0})})}function k(a){a.msgId;a.originalTs;a.rowId;a.threadJid;a.unsendMsgContentDeleteTs;a=babelHelpers.objectWithoutPropertiesLoose(a,h);return a}g.addQuoteDataToReplyMessage=a;g.getQuoteDataFromEchoMessage=b;g.updateQuoteDataForReplyMessages=f;g.enhanceAndPersistReplyMessagesWithQuoteData=j}),98);
__d("MAWHandleEchoReactionsRestore",["MAWAckLevel","MAWAuthor","MAWBulkWriteReactionsTxns","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWTransactionMode","Promise","WAJids","WALogger","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o;function a(a,c,d){d==null||d.addPoint("reactions_restore_start");var e=a.echoMsgMap,f=a.restoredMsgsData,g=0;if(f){a=f.existingMsgs;var h=f.newlyAddedMsgs;h=h.concat(a);var i=f.threadJid;a=h.filter(function(a){var b=e.get(a.externalId);return q(e,a)&&b!=null&&r(b)});if(a.length===0)return(o||(o=b("Promise"))).resolve();var j=a.flatMap(function(a){var b=e.get(a.externalId);a=u(f.threadJid,c,a.externalId,a.msgId,a.author,b);return a.map(function(a){return{chatJid:i,unstoredReaction:a}})});return j.length===0?(o||(o=b("Promise"))).resolve():p(j).then(function(a){g+=j.length,d==null||d.addPoint("reactions_restore_end",{"int":{reactions:g}})})}return(o||(o=b("Promise"))).resolve()}var p=d("MAWIndexedDb").makeMsgrTransactor({groupInfo:(c=d("MAWTransactionMode")).READWRITE,messages:c.READWRITE,reactions:c.READWRITE,threads:c.READWRITE},"restoreWriteReactionsToDb",function(a){return function(b){return d("MAWBulkWriteReactionsTxns").prepareReactionsData(a,b).then(function(b){return d("MAWBulkWriteReactionsTxns").bulkWriteReactions(a,b)})}});function q(a,b){a=a.get(b.externalId);if(a==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echo document is absent for a restored msg"])));return!1}if(d("WAJids").isAuthorSystem(b.author)){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions for system author"])));return!1}if(d("MAWAuthor").getAuthorUserJid(b.author)==null){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions empty author"])));return!1}return!0}function r(a){return a.reactions!=null&&a.reactions.length!==0&&a.reactionXOfflineThreadingIds!=null&&a.reactionXOfflineThreadingIds.length!==0&&a.reactionAuthoritativeTimestampMs!=null&&a.reactionAuthoritativeTimestampMs.length!==0}function s(a,b,c){if((a==null?void 0:a.length)===0){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction string is not a single character"])));return!1}if(b==null){d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction external id missing"])));return!1}if(c==null){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reactToAuthor field is null"])));return!1}return!0}function t(a,b,c){return(a||[]).map(function(a,e){if(c==null||b==null||(c==null?void 0:c.length)<=e||(b==null?void 0:b.length)<=e){d("WALogger").WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction fields in backup data uneven in length"])));return[]}return[a,b[e],c[e]]})}function u(a,b,c,e,f,g){var h=d("MAWAuthor").getAuthorUserJid(f);if(g==null||h==null)return[];var i=g.reactionAuthoritativeTimestampMs;i=i===void 0?[]:i;var j=g.reactionXOfflineThreadingIds;j=j===void 0?[]:j;g=g.reactions;return t(g,j,i).filter(function(a){var b=a[0];a=a[1];return a!=null&&s(b.displayName,a.displayName,d("MAWAuthor").getAuthorUserJid(f))}).map(function(f){var g=f[0],i=f[1];f=f[2];var j=g.displayName;g=d("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(g,b);g={ack:g===d("WAJids").AUTHOR_ME?d("MAWAckLevel").ACK.sent:d("MAWAckLevel").ACK.received,author:g,externalId:d("WAStanzaUtils").toStanzaId(i.displayName||""),groupingKey:j,reaction:j,reactToAuthor:h,reactToExternalId:c,senderTimestampMs:null,threadJid:a,ts:d("WATimeUtils").castToUnixTime(Number(f.displayName)/1e3)};return e!=null?babelHelpers["extends"]({},g,{reactToMsgId:e}):g})}g.writeEchoReactionsToReactionsStore=a;g.getReactionsForReactionStore=u}),98);
__d("MAWHandleEchoXMARestoreV2",["EchoMessage","MAWBridge","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMediaTxns","MAWDbMsg","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWODSProxy","MAWParseXMAProtocol","MAWTransactionMode","WAArmadilloXMA.pb","WAHashUtils","WALogger","WAMediaUtils","WAOdsEnums","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q;a=function(a,b,c){b==null||b.addPoint("xma_restore_start");var e=a.restoredMsgsData;if(e){var f=e.newlyAddedMsgs;f=f.concat(e.existingMsgs);var g=[];f.map(function(b){var c=b.externalId;c=a.echoMsgMap.get(c);c!=null&&(c.contentType===d("EchoMessage").EchoMessageContentType.XMA&&g.push(b))});return g.length===0?Promise.resolve():r(g,a.echoMsgMap,c).then(function(a){b==null||b.addPoint("xma_restore_end",{int:{xma:a.length}});return Promise.resolve()})}b==null||b.addPoint("xma_restore_end",{int:{xma:0}});return Promise.resolve()};function r(a,b,c){var e=new Map(),f=new Map();a.forEach(function(a){var c,g,h=b.get(a.externalId),i=h==null||(c=h.mediaData)==null?void 0:c.attachmentObjectId;i!=null&&e.set(d("WAMediaUtils").stringToDeliveryObjectId(i),a);i=h==null||(g=h.mediaData)==null?void 0:g.plaintextHash;if(i!=null){h=d("WAHashUtils").stringToPlaintextHash(d("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(i));i=f.get(h);f.set(h,i!=null?[].concat(i,[a.msgId]):[a.msgId])}});var g=Array.from(e.keys()),j=new Map();return s(f).then(function(f){var k=[];g.forEach(function(a){var b;b=(b=e.get(a))==null?void 0:b.externalId;b!=null&&j.set(b,a)});a.filter(function(a){return d("MAWDbMsg").isXMAMsg(a)}).forEach(function(a){var c=b.get(a.externalId);if(c){var e=j.get(a.externalId),g;if(e!=null){e=f.get(e);e!=null&&(g=e.mediaId)}e=c.serializationOrigin;e==null&&(e=d("EchoMessage").EchoSerializationOriginType.UNKNOWN);c=u(a,c,g,e);c==null?d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] dbXMA is null. EchoMessage origin ",""])),e):(c.targetType===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE&&a.msgContent==null&&(d("WALogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] msgContent is null for external link share XMA on Restore. Echo message origin ",""])),e),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"missing_msg_content_external_link_xma"})),k.push(c))}});return t(k).then(function(a){if(a.length>0){a.map(async function(a){var b=j.get(a.externalId);if(c!==!0){var e;b!=null&&(e=f.get(b));b=await d("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(e,a);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:b}]})}});return a}return a})})}var s=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,mediaBackup:d("MAWTransactionMode").READONLY},"restoreGetMediaForXMAByObjectIds",function(a){return function(b){var c=Array.from(b.keys());return d("MAWDbMediaTxns").maybeBulkGetMediaFromPlaintextHash(a,c).then(function(a){var c=new Map();a.forEach(function(a){var e=b.get(a.plaintextHash);e==null||e.forEach(function(b){b=a==null?void 0:a.mediaEntries.get(b);if(a!=null&&b!=null){b=d("WAMediaUtils").decodeMediaEntryData(b);b.objectId!=null&&c.set(d("WAMediaUtils").stringToDeliveryObjectId(b.objectId),a)}else d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][getMediaForXMAByObjectIds] mediaEntry is null for media restore"])))})});return c})}}),t=d("MAWIndexedDb").makeMsgrTransactor({xma:d("MAWTransactionMode").READWRITE},"restoreWriteXMAsToDb",function(a){return function(b){return a.xma.bulkAdd(b,{allKeys:!0}).then(function(a){return a.map(function(a,c){return babelHelpers.extends({},b[c],{xmaId:a})})})}});function u(a,b,c,e){var f,g,h,i,j,r,s,t,u;if(b.xmaData==null){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaData is missing in the echo doc. Echo message origin ",""])),e);return null}var w;if(b.xmaData.xmaDefaultCTA!=null){var x;w=v((x=b.xmaData)==null?void 0:x.xmaDefaultCTA)}else d("WALogger").WARN(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaDefaultCTA field is not present in the echo doc. Echo message origin ",""])),e);if(((x=b.xmaData)==null?void 0:x.xmaTargetType)!=null)x=d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(b.xmaData.xmaTargetType);else{d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaTargetType field is not present in the echo doc. Echo message origin ",""])),e);return null}var y;((f=b.xmaData)==null?void 0:f.xmaGatingType)!=null?y=d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(b.xmaData.xmaGatingType):d("WALogger").WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaGatingType field is not present in the echo doc. Echo message origin ",""])),e);var z;((f=b.xmaData)==null?void 0:f.xmaLayoutType)!=null?z=d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(b.xmaData.xmaLayoutType):d("WALogger").WARN(o||(o=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaLayoutType field is not present in the echo doc. Echo message origin ",""])),e);if(a.threadJid!=null)f=a.threadJid;else{d("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid field is not present in the restoredMsg. Echo message origin ",""])),e);return null}if(w!=null&&!d("MAWParseXMAProtocol").isValidCTA(w,x,!0)){d("WALogger").ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid CTA observed while restoring XMA. Echo message origin ",""])),e);return null}var A;((e=b.xmaData)==null?void 0:e.xmaContentRef)!=null&&(A=b.xmaData.xmaContentRef);return{author:a.author,contentRef:A,ctas:[],defaultCTA:w,defaultPreviewMediaId:c!=null?c:void 0,externalId:a.externalId,headerTitle:b==null||(g=b.xmaData)==null?void 0:g.xmaHeaderTitle,isTombstoned:b==null||(h=b.xmaData)==null?void 0:h.xmaIsTombstoned,maxSubtitleNumOfLines:b==null||(i=b.xmaData)==null?void 0:i.xmaMaxSubtitleNumLines,maxTitleNumOfLines:b==null||(j=b.xmaData)==null?void 0:j.xmaMaxTitleNumLines,msgId:a.msgId,overlayIconGlyph:y,overlayTitle:b==null||(r=b.xmaData)==null?void 0:r.xmaHeaderSubtitle,previewMediaIds:c!=null?[c]:[],subtitleText:b==null||(s=b.xmaData)==null?void 0:s.xmaSubtitleText,targetExpiringAtSec:((e=b.xmaData)==null?void 0:e.xmaTargetExpiry)!=null?d("WATimeUtils").castToUnixTime(Number((a=b.xmaData)==null?void 0:a.xmaTargetExpiry)):void 0,targetId:b==null||(t=b.xmaData)==null?void 0:t.xmaTargetId,targetType:x,targetUsername:b==null||(u=b.xmaData)==null?void 0:u.xmaTargetUsername,threadJid:f,titleText:(c=b.xmaData)==null?void 0:c.xmaTitleText,xmaDataclass:(e=b.xmaData)==null?void 0:e.xmaDataclass,xmaLayoutType:z}}function v(a){return{actionUrl:a,buttonType:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_CTA_BUTTON_TYPE.OPEN_NATIVE,nativeUrl:a}}g.writeXMAToXMAStore=a;g.getMediaForXMAByObjectIds=s;g.writeXMAsToDb=t;g.getDefaultCTA=v}),98);
__d("MessageBackupSupplementalKeyGenerator",["$InternalEnum","MAWJids","WAGlobals","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=b("$InternalEnum")({REACTION:"reaction",EDIT:"edit",RAVEN_ACTION_MESSAGE:"raven_action_message"}),i=":";function a(a,b){return""+a+i+b}function c(a){return a.split(i)[1]}function j(a,b){b=b.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");b=new RegExp("^"+b,"i");return b.test(a)}function e(a){return j(a,h.REACTION)}function f(a){return j(a,h.EDIT)}function k(a){return j(a,h.RAVEN_ACTION_MESSAGE)}function l(a){var b=a.split(i);if(b.length===1)return{rawIdentifierString:a,type:"poll_update"};var c=b[0];if(b.length<2||b.length>3)return{prefix:c,rawIdentifierString:a,type:"unknown"};var e=b[1];e=d("MAWJids").toUserJid(e);if(c===h.REACTION)return{senderJid:e,type:"reaction"};b=b.length===3?d("WATimeUtils").castToMillisTime(Number(b[2])):null;if(c===h.RAVEN_ACTION_MESSAGE)return{senderJid:e,type:"raven_action_message"};if(b==null)return{prefix:c,rawIdentifierString:a,type:"unknown"};return c===h.EDIT?{senderJid:e,ts:b,type:"edit"}:{prefix:c,rawIdentifierString:a,type:"unknown"}}function m(a){switch(a.type){case"edit":return""+h.EDIT+i+d("WAJids").extractUserId(a.senderJid)+i+a.ts.toString();case"reaction":return""+h.REACTION+i+d("WAJids").extractUserId(a.senderJid);case"raven_action_message":return""+h.RAVEN_ACTION_MESSAGE+i+d("WAJids").extractUserId(a.senderJid);case"poll_update":return a.rawIdentifierString}}function n(a){var b;if(d("WAJids").isAuthorMe(a))b=d("WAGlobals").getMyUserJid();else{a=d("WAJids").interpretAndValidateJid(a);if(a.jidType==="msgrUser")b=a.userJid;else return null}a=d("WAJids").userIdFromJid(b);return""+h.REACTION+i+a}function o(a,b){var c;if(d("WAJids").isAuthorMe(a))c=d("WAGlobals").getMyUserJid();else{a=d("WAJids").interpretAndValidateJid(a);if(a.jidType==="msgrUser")c=a.userJid;else return null}a=d("WAJids").userIdFromJid(c);return""+h.EDIT+i+a+i+b.toString()}g.SupplementalKeyPrefix=h;g.SUPPLEMENTAL_KEY_DELIMITER=i;g.createMessageSupplementalKey_DEPRECATED=a;g.getSupplementalSenderId_DEPRECATED=c;g.isSupplementalProtobufAReaction=e;g.isSupplementalProtobufAnEdit=f;g.isSupplementalProtobufARavenAction=k;g.parseIdentifierString=l;g.toIdentifierString=m;g.createReactionSupplementalKey=n;g.createEditSupplementalKey=o}),98);
__d("MAWHandleEBRestoreWithHIM",["EBAPIWorkerCheck","EchoMessage","EncryptedBackupsUploadEntity","FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWBulkEditMsgsTxns","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMsg","MAWEchoToProtobufConversionLoggingUtils","MAWFrontendMediaUtils","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoReactionsRestore","MAWHandleEchoXMARestoreV2","MAWJids","MAWMsgType","MAWODSProxy","MAWParseXMAProtocol","MAWUnsafeCoerce","MAWUserJidWrapper","MessageBackupSupplementalKeyGenerator","Random","WAGlobals","WAHashUtils","WAJids","WALogger","WALongInt","WAOdsEnums","WAProtocolQueue","WAResultOrError","WASortedLists","WAStanzaUtils","WATimeUtils","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=["originalTs","threadJid","unsendMsgContentDeleteTs"],i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;function A(a,b){if(a==="@me"||a==="@system")return b;else return a}function B(a,b,c,e,f){var g=[];if(a.reactionXOfflineThreadingIds!=null)for(var h=0;h<a.reactionXOfflineThreadingIds.length;++h){var i=d("MAWHandleEchoReactionsRestore").getReactionsForReactionStore(b,c,e,null,f,a);i=i.map(function(a){return{decodedMsg:{unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:a,unstoredDbReceiverFetchInfo:void 0},stanza:E(a.externalId,a.ts,A(a.author,c),b,"reaction")}});g.push.apply(g,i)}return g}function C(a,b,c,e,f){return e.map(function(e){if(e.messageId==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] messageId is null in edit, original externalId: ",""])),a);f!=null&&d("MAWEchoToProtobufConversionLoggingUtils").addPoint(f,"getUnstoredDbEditsFromEcho_messageId_missing");return null}var g=e.messageId;return{decodedMsg:{unstoredDbEditActionMsg:{ack:d("MAWAckLevel").ACK.sent,author:c,editMsgContent:{content:e.text},externalId:d("WAStanzaUtils").toStanzaId(g),originalMsgExternalId:a,serverTs:d("WATimeUtils").castToUnixTime(e.timestamp),ts:d("WATimeUtils").castToUnixTime(e.timestamp),type:d("MAWMsgType").MSG_TYPE.EDIT_ACTION},unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:void 0},stanza:E(d("WAStanzaUtils").toStanzaId(g),d("WATimeUtils").castToUnixTime(e.timestamp),c,b,"text")}}).filter(Boolean)}function a(a,b){return a.map(J).filter(Boolean).map(function(a){return D(a,b)})}function D(a,b){var e,f=d("MAWUserJidWrapper").getMyUserJid(),g=a.from,h=d("MAWHandleEchoMsgsRestoreApiUtils").getDbMsgTypeFromEchoMessage(a);if(g==null||h==null)return[];h=a.xOfflineThreadingId;if(h==null){c("FBLogger")("wmi_eb").warn("xOfflineThreadingId is null for Echo message");return[]}h=d("WAStanzaUtils").toStanzaId(h);e=d("WATimeUtils").castToUnixTime(((e=a.authoritativeTimestampMs)!=null?e:a.sortOrderMs)/1e3);g=d("MAWJids").toUserJid(g.localKey);var i=I(a,b,f,h,"echo_content");if(i.success===!1)return[];i=i.value;f=B(a,b,f,h,g);var j=a.contentType===d("EchoMessage").EchoMessageContentType.TEXT||a.contentType===d("EchoMessage").EchoMessageContentType.PLACEHOLDER?"text":"media";a=C(h,b,g,a.editHistory);return[{decodedMsg:i,stanza:E(h,e,g,b,j)}].concat(f,a)}function E(a,b,c,e,f){var g={applicationPayload:new Uint8Array(0).buffer,backupDirective:null,icdc:null,metadata:null,protobuf:new Uint8Array(0),subprotocol:new Uint8Array(0),subprotocolType:"consumerMessage",type:"subprotocol",version:"v3"};g={folder:null,id:{author:c,chat:e,externalId:a},msg:g,recipientsCount:null,reportingMeta:null,ts:b,type:"IncomingMsg"};return{incomingType:"ebrestore",jid:e,message:{decrypted:g,details:{count:0,externalId:a,from:d("WAJids").switchOnMsgrChatJidType(e,{group:function(a){return{author:d("WAJids").defaultDeviceJidForUser(c),chat:a,groupJid:a,type:"group"}},user:function(a){return{author:d("WAJids").defaultDeviceJidForUser(c),chat:a,deviceJid:d("WAJids").defaultDeviceJidForUser(c),type:"device"}}}),hideDecryptionFailure:!0,isInstamadillo:!1,offline:null,recipient:null,reportingMeta:null,retryCount:0,ts:b,type:f}},priority:d("WAProtocolQueue").WAProtocolQueuePriorityLow,stanzaId:a,stanzaQueueId:d("MAWUnsafeCoerce").unsafeCoerce(-1),type:"message"}}function F(a){if(a.mediaData==null)return d("WAResultOrError").makeResult(null);var b=a.previewMediaData,c=a.sortOrderMs,e=a.xOfflineThreadingId,f=a.mediaData,g=f.attachmentObjectId,h=f.backupEntFbid,i=f.directPath,l=f.encryptedHash,m=f.filename,n=f.height,o=f.mediaContentType,p=f.mediaKey,q=f.mediaKeyTimestamp,r=f.mediaPlayableDuration,s=f.plaintextHash,t=f.previewContentHeight,u=f.previewContentWidth,v=f.size;f=f.width;var w=a.contentType===d("EchoMessage").EchoMessageContentType.XMA;o=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(o||"",w);w=o.mediaType;o=o.serverMediaType;var x=d("WAHashUtils").stringToPlaintextHash(d("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(s)),y=null;if(b!=null)try{y=d("MAWHandleEchoMediaMsgsRestoreV2").constructRawDownloadableThumbnail(b),y!=null&&y.objectId==null&&d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloadableThumbnail was created without metadata, source: protobuf"])))}catch(b){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",", msg id: ",". Echo message origin ",""])),b,e,a.serializationOrigin)}if(p==null)return d("WAResultOrError").makeError("missing_media_key");if(l==null)return d("WAResultOrError").makeError("missing_encrypted_hash");b=d("MAWHandleEchoMediaMsgsRestoreV2").constructMediaEntry(x,l,p,i,q,o,m,h,g,y,v);e=d("MAWHandleEchoMediaMsgsRestoreV2").getMediaInfo({filename:m,height:n,mediaPlayableDuration:r,mediaType:w,previewContentHeight:t,previewContentWidth:u,width:f});a=e.validatedAudioInfo;x=e.validatedDocumentFileInfo;l=e.validatedImageInfo;p=e.validatedVideoInfo;return d("WAResultOrError").makeResult({mediaEntry:b,mediaType:w,msgIds:d("WASortedLists").asSortedSet(new Set()),plaintextHash:d("WAHashUtils").stringToPlaintextHash(s),size:v||0,ts:q!=null?d("WATimeUtils").castToUnixTime(q):d("WATimeUtils").castMilliSecondsToUnixTime(c),validatedAudioInfo:a,validatedDocumentFileInfo:x,validatedImageInfo:l,validatedVideoInfo:p})}function G(a,b){if(a.xmaData==null||a.from==null||a.xOfflineThreadingId==null)return d("WAResultOrError").makeResult(null);var c=a.from,e=a.serializationOrigin,f=a.xmaData;a=a.xOfflineThreadingId;var g=f.xmaContentRef,h=f.xmaDataclass,i=f.xmaDefaultCTA,j=f.xmaGatingType,k=f.xmaHeaderSubtitle,n=f.xmaHeaderTitle,o=f.xmaIsTombstoned,p=f.xmaLayoutType,q=f.xmaMaxSubtitleNumLines,r=f.xmaMaxTitleNumLines,s=f.xmaSubtitleText,t=f.xmaTargetExpiry,u=f.xmaTargetId,v=f.xmaTargetType,w=f.xmaTargetUsername;f=f.xmaTitleText;if(v==null){d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Mandatory XMA Data missing for XMA message. Echo message origin ",""])),e);return d("WAResultOrError").makeError("xma_mandatory_fields_missing")}v=d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(v);var x;i!=null&&(x=d("MAWHandleEchoXMARestoreV2").getDefaultCTA(i));if(x!=null&&!d("MAWParseXMAProtocol").isValidCTA(x,v,!0)){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] defautlCTA failed validation check. Echo message origin ",""])),e);return d("WAResultOrError").makeError("xma_cta_validation_failure")}var y;j!=null&&(y=d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(j));var z;t!=null&&(z=d("WATimeUtils").castToUnixTime(t));var A;p!=null&&(A=d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(p));return d("WAResultOrError").makeResult({unstoredDbXMA:{author:d("MAWJids").toUserJid(c.localKey),contentRef:g,ctas:[],defaultCTA:x,externalId:d("WAStanzaUtils").toStanzaId(a),headerTitle:n,isTombstoned:o,maxSubtitleNumOfLines:q,maxTitleNumOfLines:r,overlayDescription:k,overlayIconGlyph:y,overlayTitle:n,subtitleText:s,targetExpiringAtSec:z,targetId:u,targetType:v,targetUsername:w,threadJid:b,titleText:f,xmaDataclass:h,xmaLayoutType:A}})}function H(a){if(a.receiverFetchId==null||a.receiverFetchData==null)return d("WAResultOrError").makeResult(null);var b=a.receiverFetchData,c=a.receiverFetchId;if(b.type!=="sticker"){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unsupported receiver fetch message type: ",". Echo message origin ",""])),b.type,a.serializationOrigin);return d("WAResultOrError").makeError("unsupported_message_type")}return d("WAResultOrError").makeResult({mimetype:b.mimetype,previewHeight:b.previewHeight,previewWidth:b.previewWidth,receiverFetchId:c,type:b.type})}function I(a,b,c,e,f){c=d("MAWHandleEchoMsgsRestoreApiUtils").getUnstoredDbMessageFromEchoMessage(a,b,c,e,void 0,f);if(c.success===!1)return d("WAResultOrError").makeError(c.error);e=c.value;e.originalTs;e.threadJid;e.unsendMsgContentDeleteTs;f=babelHelpers.objectWithoutPropertiesLoose(e,h);f.sortOrderMs=a.sortOrderMs;c=F(a);if(c.success===!1)return c;e=G(a,b);if(e.success===!1)return d("WAResultOrError").makeError(e.error);b=e.value;e=H(a);if(e.success===!1)return d("WAResultOrError").makeError(e.error);a=e.value;return d("WAResultOrError").makeResult({unstoredDbMedia:c.value,unstoredDbMsg:f,unstoredDbReaction:void 0,unstoredDbReceiverFetchInfo:a!=null?a:void 0,unstoredXMA:b!=null?b:void 0})}function J(a){try{return d("EchoMessage").decodeEchoMessage(a)}catch(a){d("WALogger").ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode echo message: ",""])),a);return null}}function b(a,b){if(!d("EBAPIWorkerCheck").runningInWorker())throw c("FBLogger")("messenger_web").mustfixThrow("convertEchoMessagesToEBProtobufs should be called from the worker thread");var e=a.map(function(a){return K(a,b)}).filter(Boolean);d("MAWODSProxy").odsBumpEntityKey({amount:e.length,entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.success"});e.length!==a.length&&(d("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to convert all echo messages to protobuf. Chat: ",", echo messages count: ",", converted echo messages count: ",""])),b,a.length,e.length),d("MAWODSProxy").odsBumpEntityKey({amount:a.length-e.length,entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.fail"}));return e}function K(a,b){var e=c("Random").uint32();d("MAWEchoToProtobufConversionLoggingUtils").startQplUserFlow(e);a=J(a);if(a==null){d("WALogger").ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to decode echo message"])));d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"echo_decode_failure");return null}var f=d("WAGlobals").getMyUserJid(),g=a.from,h=a.sortOrderMs,i=a.xOfflineThreadingId;h=d("WATimeUtils").castToMillisTime(h);if(i==null||g==null){d("WALogger").ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] One of the mandatory fields is null for Echo message. Echo message origin ",""])),a.serializationOrigin);d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"mandatory_fields_missing");return null}var j=d("MAWJids").toUserJid(g.localKey);g=d("WAStanzaUtils").toStanzaId(i);i=I(a,b,f,g,"first_edit_content");if(i.success===!1){d("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: ",""])),i.error);d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"echo_message_parsing_failure_"+i.error);return null}if(i.value.unstoredDbMsg==null){d("WALogger").ERROR(t||(t=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: unstoredDbMsg missing in UnstoredDbContent"])));d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"unstoredDbMsg_conversion_failure_unstoredDbMsg_missing");return null}i=i.value;var k=i.unstoredDbMedia,l=i.unstoredDbMsg,m=i.unstoredDbReceiverFetchInfo;i=i.unstoredXMA;var n={author:j,chat:b,externalId:g};l!=null&&(l.msgId=d("MAWDbMsg").stanzaIdToMsgId(g));(i==null?void 0:i.unstoredDbXMA)!=null&&(i.unstoredDbXMA.msgId=d("MAWDbMsg").stanzaIdToMsgId(g));k!=null&&(k.msgIds=d("WASortedLists").asSortedSet(new Set([d("MAWDbMsg").stanzaIdToMsgId(g)])));var o;(i==null?void 0:i.unstoredDbXMA)!=null&&(o={associatedMessage:null,defaultPreview:k!=null?k:null,favicon:null,header:k!=null?k:null,previews:k!=null?[k]:null,xma:i.unstoredDbXMA});var p={frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},A;try{A={decryptedProtobuf:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(d("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:d("MAWAsMessageApplication").encodeMessageApplication(l,k,null,o,b,c("justknobx")._("3632")?m:null),msgId:n,reportingMeta:p,sortOrderMs:h})),protobufTimestampMS:h}}catch(a){d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"top_level_protobuf_encoding_failure");d("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Exception when trying to encode top-level protobuf: ",""])),a);return null}var D=new Map();i=C(g,b,j,a.editHistory).map(function(a){return(a=a.decodedMsg)==null?void 0:a.unstoredDbEditActionMsg}).filter(Boolean).filter(function(a){return a.externalId!==a.originalMsgExternalId}).map(function(a){return d("MAWBulkEditMsgsTxns").getMessageHistory(a,b)});i.length>0&&d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"convert_edits");i.forEach(function(a){var c=a.author,f=a.editTs;c=d("MessageBackupSupplementalKeyGenerator").createEditSupplementalKey(c,d("WATimeUtils").castUnixTimeToMillisTime(f));if(c==null){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"edit_supplemental_key_generation_failure");d("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create edit supplemental key"])));return}if(a.editExternalId==null){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"edit_supplemental_key_generation_failure");d("WALogger").ERROR(w||(w=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to fetch edit external id"])));return}var g=a.editExternalId;try{D.set(c,{decryptedProtobuf:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(d("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:d("MAWAsMessageApplication").encodeEditMessageApplication(a),msgId:{author:j,chat:b,externalId:g},reportingMeta:p,sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(a.editTs)})),protobufTimestampMS:d("WATimeUtils").castUnixTimeToMillisTime(f)})}catch(a){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"edit_supplemental_protobuf_encoding_failure"),d("WALogger").ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode edit supplemental protobuf: ",""])),a)}});l=B(a,b,f,g,j).map(function(a){return(a=a.decodedMsg)==null?void 0:a.unstoredDbReaction}).filter(Boolean);l.length>0&&d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"convert_reactions");l.forEach(function(a){var c=a.author,f=a.senderTimestampMs,g=a.ts;f=f!=null?d("WATimeUtils").castToMillisTime(d("WALongInt").numberOrThrowIfTooLarge(f)):d("WATimeUtils").castUnixTimeToMillisTime(g);g=d("MessageBackupSupplementalKeyGenerator").createReactionSupplementalKey(c);if(g==null){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"reaction_supplemental_key_generation_failure");d("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create reaction supplemental key"])));return}try{D.set(g,{decryptedProtobuf:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(d("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:d("MAWAsMessageApplication").encodeReactionMessageApplication(a),msgId:{author:j,chat:b,externalId:a.externalId},reportingMeta:p,sortOrderMs:f})),protobufTimestampMS:f})}catch(a){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"reaction_supplemental_protobuf_encoding_failure"),d("WALogger").ERROR(z||(z=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode reaction supplemental protobuf: ",""])),a)}});d("MAWEchoToProtobufConversionLoggingUtils").endSuccess(e);return{otid:g,supplementalProtobufs:D,toplevelProtobuf:A}}g.convertEchoMessages=a;g.convertEchoMessagesToEBProtobufs=b}),98);